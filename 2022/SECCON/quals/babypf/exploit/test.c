#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>

#include <linux/bpf.h>
#include "filter.h"
#include "bpf_helper.h"

static int test(void){
	int map_fd, prog_fd;
	uint64_t value;

	bpf_log_level = 2;

	map_fd = bpf_create_map(BPF_MAP_TYPE_ARRAY, sizeof(value), 0x10);
	bpf_update_elem(map_fd, 0x0, (uint64_t[1]){0xdeadbeef}, BPF_ANY);
	bpf_update_elem(map_fd, 0x1, (uint64_t[1]){0xcafebabe}, BPF_ANY);

	struct bpf_insn prog[] = {
		BPF_ST_MEM(BPF_DW, BPF_REG_FP, -0x08, 0x0),
		BPF_LD_MAP_FD(BPF_REG_ARG1, map_fd),
		BPF_MOV64_REG(BPF_REG_ARG2, BPF_REG_FP),
		BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG2, -0x08),
		BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),
		BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),
		BPF_EXIT_INSN(),
		BPF_LDX_MEM(BPF_DW, BPF_REG_9, BPF_REG_0, 0),
		BPF_ALU64_IMM(BPF_AND, BPF_REG_9, 0xffff0000),

		BPF_ST_MEM(BPF_DW, BPF_REG_FP, -0x08, 0x1),
		BPF_LD_MAP_FD(BPF_REG_ARG1, map_fd),
		BPF_MOV64_REG(BPF_REG_ARG2, BPF_REG_FP),
		BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG2, -0x08),
		BPF_EMIT_CALL(BPF_FUNC_map_lookup_elem),
		BPF_JMP_IMM(BPF_JNE, BPF_REG_0, 0, 1),
		BPF_EXIT_INSN(),
		BPF_LDX_MEM(BPF_DW, BPF_REG_8, BPF_REG_0, 0),
		BPF_ALU64_IMM(BPF_AND, BPF_REG_8, 0xffff),

		BPF_ALU64_REG(BPF_OR, BPF_REG_9, BPF_REG_8),
		BPF_STX_MEM(BPF_DW, BPF_REG_FP, BPF_REG_9, -0x10),

		BPF_ST_MEM(BPF_DW, BPF_REG_FP, -0x08, 0x2),
		BPF_LD_MAP_FD(BPF_REG_ARG1, map_fd),
		BPF_MOV64_REG(BPF_REG_ARG2, BPF_REG_FP),
		BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG2, -0x08),
		BPF_MOV64_REG(BPF_REG_ARG3, BPF_REG_FP),
		BPF_ALU64_IMM(BPF_ADD, BPF_REG_ARG3, -0x10),
		BPF_MOV64_IMM(BPF_REG_ARG4, BPF_ANY),
		BPF_EMIT_CALL(BPF_FUNC_map_update_elem),
		
		BPF_MOV64_IMM(BPF_REG_0, 1),
		BPF_EXIT_INSN(),
	};

	prog_fd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, prog, sizeof(prog)/sizeof(struct bpf_insn));

	int socks[2];
	socketpair(AF_UNIX, SOCK_DGRAM, 0, socks);
	setsockopt(socks[0], SOL_SOCKET, SO_ATTACH_BPF, &prog_fd, sizeof(prog_fd));

	write(socks[1], "", 1);
	puts(bpf_log_buf);

	for(int i=0; i<0x10; i++){
		bpf_lookup_elem(map_fd, i, &value);
		printf("map[%02d] = 0x%lx\n", i, value);
	}
}

int main(void){
	test();
}
